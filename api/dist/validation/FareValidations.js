"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.fareManagementValidations = void 0;

var _import = require("../settings/import");

var _rideTypeModel = _interopRequireDefault(require("../data-base/models/rideTypeModel"));

var _fareManagement = _interopRequireDefault(require("../data-base/models/fareManagement"));

var _state = _interopRequireDefault(require("../data-base/models/state"));

var _district = _interopRequireDefault(require("../data-base/models/district"));

var _taluk = _interopRequireDefault(require("../data-base/models/taluk"));

var _vehicaleCategoryModel = _interopRequireDefault(require("../data-base/models/vehicaleCategoryModel"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const fareManagementValidations = [(0, _import.check)('_id').optional().custom(async v => {
  try {
    const r = await _fareManagement.default.findById(v);

    if (!r) {
      throw new Error("Data not found");
    }
  } catch (e) {
    throw new Error("This data does not exit. Please check or refresh");
  }
}), (0, _import.check)('rideType').notEmpty().withMessage("The 'Ride Type' field is required").custom(async (value, {
  req
}) => {
  const result = await _rideTypeModel.default.findById(value);

  if (!result) {
    throw new Error("Invalid ride type");
  } else {
    req.body.serviceType = result.serviceType;
  }
}), (0, _import.check)('vehicleCategory').notEmpty().withMessage("The 'Vehicle Category' field is required").custom(async value => {
  const result = await _vehicaleCategoryModel.default.findById(value);

  if (!result) {
    throw new Error("Invalid vehicle category");
  }
}), (0, _import.check)('state').optional().notEmpty().withMessage("'State' field is required").custom(async value => {
  try {
    const result = await _state.default.findById(value);

    if (!result) {
      throw new Error("Data not found");
    }
  } catch (e) {
    throw new Error("'State' field is not valid");
  }
}), (0, _import.check)('district').optional().notEmpty().withMessage("'District' is required").custom(async (value, {
  req
}) => {
  try {
    const result = await _district.default.findById(value);

    if (!result) {
      throw new Error("Data not found");
    }

    req.body.state = result.state;
  } catch (e) {
    throw new Error("'District' is not valid");
  }
}), (0, _import.check)('taluk').optional().notEmpty().withMessage("'Taluk' field is required").custom(async (value, {
  req
}) => {
  try {
    const result = await _taluk.default.findById(value);

    if (!result) {
      throw new Error("Data not found");
    }

    req.body.district = result.district;
    const resultDistrict = await _district.default.findById(result.district);
    req.body.state = resultDistrict.state;
  } catch (e) {
    throw new Error("'Taluk' field is not valid");
  }
}), (0, _import.check)('baseFare').notEmpty().withMessage("The 'Base Fare' field is required").isNumeric().withMessage("The 'Base Fare' field must be numeric"), (0, _import.check)('bookingFare').notEmpty().withMessage("The 'Booking Fare' field is required").isNumeric().withMessage("The 'Booking Fare' field must be numeric"), (0, _import.check)('perMinuteFare').notEmpty().withMessage("The 'Per Minute Fare' field is required").isNumeric().withMessage("The 'Per Minute Fare' field must be numeric"), (0, _import.check)('cancelCharge').notEmpty().withMessage("The 'Cancel Charge' field is required").isNumeric().withMessage("The 'Cancel Charge' field must be numeric"), (0, _import.check)('waitingCharge').notEmpty().withMessage("The 'Waiting Charge' field is required").isNumeric().withMessage("The 'Waiting Charge' field must be numeric"), (0, _import.check)('adminCommissionType').notEmpty().withMessage("The 'Admin Commission Type' field is required").isIn(['flat', 'percentage']).withMessage("The 'Admin Commission Type' field is not valid"), (0, _import.check)('adminCommissionValue').notEmpty().withMessage("The 'Admin Commission Value' field is required").isNumeric().withMessage("The 'Admin Commission Value' field must be numeric"), (0, _import.check)('perKMCharges').custom(async (value, {
  req
}) => {
  const result = await _rideTypeModel.default.findById(req.body.rideType);

  if (!result) {
    throw new Error("Invalid ride type");
  } else if (["taxi-pickup-drop", "taxi-rentals", "cargo-daily-ride", "cargo-rentals"].includes(result.key)) {
    if (!value) {
      throw new Error("Per KM Charges are required");
    } else if (!Array.isArray(value)) {
      throw new Error("Per KM Charges are not valid");
    } else {
      value.forEach((v, i) => {
        if (!(parseFloat(i === 0 ? 0 : value[i - 1].maxKM) < parseFloat(v.maxKM)) || !v.charge) {
          throw new Error("All maxKM & charges of 'Per KM Charges' must be valid");
        }
      });
    }
  }
})];
exports.fareManagementValidations = fareManagementValidations;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy92YWxpZGF0aW9uL0ZhcmVWYWxpZGF0aW9ucy5qcyJdLCJuYW1lcyI6WyJmYXJlTWFuYWdlbWVudFZhbGlkYXRpb25zIiwib3B0aW9uYWwiLCJjdXN0b20iLCJ2IiwiciIsIkZhcmVNYW5hZ2VtZW50TW9kZWwiLCJmaW5kQnlJZCIsIkVycm9yIiwiZSIsIm5vdEVtcHR5Iiwid2l0aE1lc3NhZ2UiLCJ2YWx1ZSIsInJlcSIsInJlc3VsdCIsIlJpZGVUeXBlTW9kZWwiLCJib2R5Iiwic2VydmljZVR5cGUiLCJWZWhpY2xlQ2F0ZWdvcnlNb2RlbCIsIlN0YXRlTW9kZWwiLCJEaXN0cmljdE1vZGVsIiwic3RhdGUiLCJUYWx1a01vZGVsIiwiZGlzdHJpY3QiLCJyZXN1bHREaXN0cmljdCIsImlzTnVtZXJpYyIsImlzSW4iLCJyaWRlVHlwZSIsImluY2x1ZGVzIiwia2V5IiwiQXJyYXkiLCJpc0FycmF5IiwiZm9yRWFjaCIsImkiLCJwYXJzZUZsb2F0IiwibWF4S00iLCJjaGFyZ2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVPLE1BQU1BLHlCQUF5QixHQUFHLENBRXJDLG1CQUFNLEtBQU4sRUFDS0MsUUFETCxHQUVLQyxNQUZMLENBRVksTUFBT0MsQ0FBUCxJQUFhO0FBQ2pCLE1BQUk7QUFDQSxVQUFNQyxDQUFDLEdBQUcsTUFBTUMsd0JBQW9CQyxRQUFwQixDQUE2QkgsQ0FBN0IsQ0FBaEI7O0FBQ0EsUUFBSSxDQUFDQyxDQUFMLEVBQVE7QUFDSixZQUFNLElBQUlHLEtBQUosQ0FBVSxnQkFBVixDQUFOO0FBQ0g7QUFDSixHQUxELENBS0UsT0FBT0MsQ0FBUCxFQUFVO0FBQ1IsVUFBTSxJQUFJRCxLQUFKLENBQVUsa0RBQVYsQ0FBTjtBQUNIO0FBQ0osQ0FYTCxDQUZxQyxFQWVyQyxtQkFBTSxVQUFOLEVBQ0tFLFFBREwsR0FDZ0JDLFdBRGhCLENBQzRCLG1DQUQ1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QUNBLE1BQUksQ0FBQ2IsTUFBTCxFQUFhO0FBQ1QsVUFBTSxJQUFJTixLQUFKLENBQVUsbUJBQVYsQ0FBTjtBQUNILEdBRkQsTUFFTyxJQUFJLENBQUMsa0JBQUQsRUFBcUIsY0FBckIsRUFBcUMsa0JBQXJDLEVBQXlELGVBQXpELEVBQTBFb0IsUUFBMUUsQ0FBbUZkLE1BQU0sQ0FBQ2UsR0FBMUYsQ0FBSixFQUFvRztBQUN2RyxRQUFJLENBQUNqQixLQUFMLEVBQVk7QUFDUixZQUFNLElBQUlKLEtBQUosQ0FBVSw2QkFBVixDQUFOO0FBQ0gsS0FGRCxNQUVPLElBQUksQ0FBQ3NCLEtBQUssQ0FBQ0MsT0FBTixDQUFjbkIsS0FBZCxDQUFMLEVBQTJCO0FBQzlCLFlBQU0sSUFBSUosS0FBSixDQUFVLDhCQUFWLENBQU47QUFDSCxLQUZNLE1BRUE7QUFDSEksTUFBQUEsS0FBSyxDQUFDb0IsT0FBTixDQUFjLENBQUM1QixDQUFELEVBQUk2QixDQUFKLEtBQVU7QUFDcEIsWUFBSyxFQUFFQyxVQUFVLENBQUNELENBQUMsS0FBSyxDQUFOLEdBQVUsQ0FBVixHQUFlckIsS0FBSyxDQUFDcUIsQ0FBQyxHQUFHLENBQUwsQ0FBTCxDQUFhRSxLQUE3QixDQUFWLEdBQWlERCxVQUFVLENBQUM5QixDQUFDLENBQUMrQixLQUFILENBQTdELEtBQTJFLENBQUMvQixDQUFDLENBQUNnQyxNQUFuRixFQUE0RjtBQUN4RixnQkFBTSxJQUFJNUIsS0FBSixDQUFVLHVEQUFWLENBQU47QUFDSDtBQUNKLE9BSkQ7QUFLSDtBQUNKO0FBQ0osQ0FsQkwsQ0EvR3FDLENBQWxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY2hlY2sgfSBmcm9tICcuLi9zZXR0aW5ncy9pbXBvcnQnO1xyXG5pbXBvcnQgUmlkZVR5cGVNb2RlbCBmcm9tICcuLi9kYXRhLWJhc2UvbW9kZWxzL3JpZGVUeXBlTW9kZWwnO1xyXG5pbXBvcnQgRmFyZU1hbmFnZW1lbnRNb2RlbCBmcm9tICcuLi9kYXRhLWJhc2UvbW9kZWxzL2ZhcmVNYW5hZ2VtZW50JztcclxuaW1wb3J0IFN0YXRlTW9kZWwgZnJvbSAnLi4vZGF0YS1iYXNlL21vZGVscy9zdGF0ZSc7XHJcbmltcG9ydCBEaXN0cmljdE1vZGVsIGZyb20gJy4uL2RhdGEtYmFzZS9tb2RlbHMvZGlzdHJpY3QnO1xyXG5pbXBvcnQgVGFsdWtNb2RlbCBmcm9tICcuLi9kYXRhLWJhc2UvbW9kZWxzL3RhbHVrJztcclxuaW1wb3J0IFZlaGljbGVDYXRlZ29yeU1vZGVsIGZyb20gJy4uL2RhdGEtYmFzZS9tb2RlbHMvdmVoaWNhbGVDYXRlZ29yeU1vZGVsJztcclxuXHJcbmV4cG9ydCBjb25zdCBmYXJlTWFuYWdlbWVudFZhbGlkYXRpb25zID0gW1xyXG5cclxuICAgIGNoZWNrKCdfaWQnKVxyXG4gICAgICAgIC5vcHRpb25hbCgpXHJcbiAgICAgICAgLmN1c3RvbShhc3luYyAodikgPT4ge1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgciA9IGF3YWl0IEZhcmVNYW5hZ2VtZW50TW9kZWwuZmluZEJ5SWQodik7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXIpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJEYXRhIG5vdCBmb3VuZFwiKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVGhpcyBkYXRhIGRvZXMgbm90IGV4aXQuIFBsZWFzZSBjaGVjayBvciByZWZyZXNoXCIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSksXHJcblxyXG4gICAgY2hlY2soJ3JpZGVUeXBlJylcclxuICAgICAgICAubm90RW1wdHkoKS53aXRoTWVzc2FnZShcIlRoZSAnUmlkZSBUeXBlJyBmaWVsZCBpcyByZXF1aXJlZFwiKVxyXG4gICAgICAgIC5jdXN0b20oYXN5bmMgKHZhbHVlLCB7IHJlcSB9KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFJpZGVUeXBlTW9kZWwuZmluZEJ5SWQodmFsdWUpO1xyXG4gICAgICAgICAgICBpZiAoIXJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCByaWRlIHR5cGVcIik7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXEuYm9keS5zZXJ2aWNlVHlwZSA9IHJlc3VsdC5zZXJ2aWNlVHlwZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pLFxyXG5cclxuICAgIGNoZWNrKCd2ZWhpY2xlQ2F0ZWdvcnknKVxyXG4gICAgICAgIC5ub3RFbXB0eSgpLndpdGhNZXNzYWdlKFwiVGhlICdWZWhpY2xlIENhdGVnb3J5JyBmaWVsZCBpcyByZXF1aXJlZFwiKVxyXG4gICAgICAgIC5jdXN0b20oYXN5bmMgKHZhbHVlKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFZlaGljbGVDYXRlZ29yeU1vZGVsLmZpbmRCeUlkKHZhbHVlKTtcclxuICAgICAgICAgICAgaWYgKCFyZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgdmVoaWNsZSBjYXRlZ29yeVwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pLFxyXG5cclxuXHJcbiAgICBjaGVjaygnc3RhdGUnKVxyXG4gICAgICAgIC5vcHRpb25hbCgpXHJcbiAgICAgICAgLm5vdEVtcHR5KCkud2l0aE1lc3NhZ2UoXCInU3RhdGUnIGZpZWxkIGlzIHJlcXVpcmVkXCIpXHJcbiAgICAgICAgLmN1c3RvbShhc3luYyAodmFsdWUpID0+IHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFN0YXRlTW9kZWwuZmluZEJ5SWQodmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJEYXRhIG5vdCBmb3VuZFwiKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiJ1N0YXRlJyBmaWVsZCBpcyBub3QgdmFsaWRcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KSxcclxuXHJcbiAgICBjaGVjaygnZGlzdHJpY3QnKVxyXG4gICAgICAgIC5vcHRpb25hbCgpXHJcbiAgICAgICAgLm5vdEVtcHR5KCkud2l0aE1lc3NhZ2UoXCInRGlzdHJpY3QnIGlzIHJlcXVpcmVkXCIpXHJcbiAgICAgICAgLmN1c3RvbShhc3luYyAodmFsdWUsIHsgcmVxIH0pID0+IHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IERpc3RyaWN0TW9kZWwuZmluZEJ5SWQodmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJEYXRhIG5vdCBmb3VuZFwiKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJlcS5ib2R5LnN0YXRlID0gcmVzdWx0LnN0YXRlO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCInRGlzdHJpY3QnIGlzIG5vdCB2YWxpZFwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pLFxyXG5cclxuICAgIGNoZWNrKCd0YWx1aycpXHJcbiAgICAgICAgLm9wdGlvbmFsKClcclxuICAgICAgICAubm90RW1wdHkoKS53aXRoTWVzc2FnZShcIidUYWx1aycgZmllbGQgaXMgcmVxdWlyZWRcIilcclxuICAgICAgICAuY3VzdG9tKGFzeW5jICh2YWx1ZSwgeyByZXEgfSkgPT4ge1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgVGFsdWtNb2RlbC5maW5kQnlJZCh2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkRhdGEgbm90IGZvdW5kXCIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmVxLmJvZHkuZGlzdHJpY3QgPSByZXN1bHQuZGlzdHJpY3Q7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHREaXN0cmljdCA9IGF3YWl0IERpc3RyaWN0TW9kZWwuZmluZEJ5SWQocmVzdWx0LmRpc3RyaWN0KTtcclxuICAgICAgICAgICAgICAgIHJlcS5ib2R5LnN0YXRlID0gcmVzdWx0RGlzdHJpY3Quc3RhdGU7XHJcblxyXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCInVGFsdWsnIGZpZWxkIGlzIG5vdCB2YWxpZFwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pLFxyXG5cclxuICAgIGNoZWNrKCdiYXNlRmFyZScpXHJcbiAgICAgICAgLm5vdEVtcHR5KCkud2l0aE1lc3NhZ2UoXCJUaGUgJ0Jhc2UgRmFyZScgZmllbGQgaXMgcmVxdWlyZWRcIilcclxuICAgICAgICAuaXNOdW1lcmljKCkud2l0aE1lc3NhZ2UoXCJUaGUgJ0Jhc2UgRmFyZScgZmllbGQgbXVzdCBiZSBudW1lcmljXCIpLFxyXG5cclxuICAgIGNoZWNrKCdib29raW5nRmFyZScpXHJcbiAgICAgICAgLm5vdEVtcHR5KCkud2l0aE1lc3NhZ2UoXCJUaGUgJ0Jvb2tpbmcgRmFyZScgZmllbGQgaXMgcmVxdWlyZWRcIilcclxuICAgICAgICAuaXNOdW1lcmljKCkud2l0aE1lc3NhZ2UoXCJUaGUgJ0Jvb2tpbmcgRmFyZScgZmllbGQgbXVzdCBiZSBudW1lcmljXCIpLFxyXG5cclxuICAgIGNoZWNrKCdwZXJNaW51dGVGYXJlJylcclxuICAgICAgICAubm90RW1wdHkoKS53aXRoTWVzc2FnZShcIlRoZSAnUGVyIE1pbnV0ZSBGYXJlJyBmaWVsZCBpcyByZXF1aXJlZFwiKVxyXG4gICAgICAgIC5pc051bWVyaWMoKS53aXRoTWVzc2FnZShcIlRoZSAnUGVyIE1pbnV0ZSBGYXJlJyBmaWVsZCBtdXN0IGJlIG51bWVyaWNcIiksXHJcblxyXG4gICAgY2hlY2soJ2NhbmNlbENoYXJnZScpXHJcbiAgICAgICAgLm5vdEVtcHR5KCkud2l0aE1lc3NhZ2UoXCJUaGUgJ0NhbmNlbCBDaGFyZ2UnIGZpZWxkIGlzIHJlcXVpcmVkXCIpXHJcbiAgICAgICAgLmlzTnVtZXJpYygpLndpdGhNZXNzYWdlKFwiVGhlICdDYW5jZWwgQ2hhcmdlJyBmaWVsZCBtdXN0IGJlIG51bWVyaWNcIiksXHJcblxyXG4gICAgY2hlY2soJ3dhaXRpbmdDaGFyZ2UnKVxyXG4gICAgICAgIC5ub3RFbXB0eSgpLndpdGhNZXNzYWdlKFwiVGhlICdXYWl0aW5nIENoYXJnZScgZmllbGQgaXMgcmVxdWlyZWRcIilcclxuICAgICAgICAuaXNOdW1lcmljKCkud2l0aE1lc3NhZ2UoXCJUaGUgJ1dhaXRpbmcgQ2hhcmdlJyBmaWVsZCBtdXN0IGJlIG51bWVyaWNcIiksXHJcblxyXG4gICAgY2hlY2soJ2FkbWluQ29tbWlzc2lvblR5cGUnKVxyXG4gICAgICAgIC5ub3RFbXB0eSgpLndpdGhNZXNzYWdlKFwiVGhlICdBZG1pbiBDb21taXNzaW9uIFR5cGUnIGZpZWxkIGlzIHJlcXVpcmVkXCIpXHJcbiAgICAgICAgLmlzSW4oWydmbGF0JywgJ3BlcmNlbnRhZ2UnXSkud2l0aE1lc3NhZ2UoXCJUaGUgJ0FkbWluIENvbW1pc3Npb24gVHlwZScgZmllbGQgaXMgbm90IHZhbGlkXCIpLFxyXG5cclxuICAgIGNoZWNrKCdhZG1pbkNvbW1pc3Npb25WYWx1ZScpXHJcbiAgICAgICAgLm5vdEVtcHR5KCkud2l0aE1lc3NhZ2UoXCJUaGUgJ0FkbWluIENvbW1pc3Npb24gVmFsdWUnIGZpZWxkIGlzIHJlcXVpcmVkXCIpXHJcbiAgICAgICAgLmlzTnVtZXJpYygpLndpdGhNZXNzYWdlKFwiVGhlICdBZG1pbiBDb21taXNzaW9uIFZhbHVlJyBmaWVsZCBtdXN0IGJlIG51bWVyaWNcIiksXHJcblxyXG4gICAgY2hlY2soJ3BlcktNQ2hhcmdlcycpXHJcbiAgICAgICAgLmN1c3RvbShhc3luYyAodmFsdWUsIHsgcmVxIH0pID0+IHtcclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgUmlkZVR5cGVNb2RlbC5maW5kQnlJZChyZXEuYm9keS5yaWRlVHlwZSk7XHJcbiAgICAgICAgICAgIGlmICghcmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIHJpZGUgdHlwZVwiKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChbXCJ0YXhpLXBpY2t1cC1kcm9wXCIsIFwidGF4aS1yZW50YWxzXCIsIFwiY2FyZ28tZGFpbHktcmlkZVwiLCBcImNhcmdvLXJlbnRhbHNcIl0uaW5jbHVkZXMocmVzdWx0LmtleSkpIHtcclxuICAgICAgICAgICAgICAgIGlmICghdmFsdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJQZXIgS00gQ2hhcmdlcyBhcmUgcmVxdWlyZWRcIik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFBcnJheS5pc0FycmF5KHZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlBlciBLTSBDaGFyZ2VzIGFyZSBub3QgdmFsaWRcIik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlLmZvckVhY2goKHYsIGkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCAhKHBhcnNlRmxvYXQoaSA9PT0gMCA/IDAgOiAodmFsdWVbaSAtIDFdLm1heEtNKSkgPCBwYXJzZUZsb2F0KHYubWF4S00pKSB8fCAhdi5jaGFyZ2UgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJBbGwgbWF4S00gJiBjaGFyZ2VzIG9mICdQZXIgS00gQ2hhcmdlcycgbXVzdCBiZSB2YWxpZFwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSksXHJcblxyXG5dO1xyXG4iXX0=