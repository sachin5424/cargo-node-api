"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.validationMiddleware = exports.userRegisterValidation = exports.userLoginMobileNumberValidation = exports.userForgetPasswordValidation = exports.profileUpdateValidation = exports.otpVerified = exports.chnagePasswordValidation = void 0;

var _expressValidator = require("express-validator");

var _customer = _interopRequireDefault(require("../../../data-base/models/customer"));

var _bcryptjs = _interopRequireDefault(require("bcryptjs"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const errorMessage = {
  required: 'The field is required',
  minLength: 'This field must be at least ',
  minField: 'characters',
  email: 'Please enter a valid email address',
  dateTime: 'Invalid date time format'
};

const validationMiddleware = (req, res, next) => {
  try {
    const errors = (0, _expressValidator.validationResult)(req);

    if (!errors.isEmpty()) {
      res.status(422).json({
        errors: errors.array()
      });
    } else {
      next();
    }
  } catch (error) {
    res.status(500).json({
      status: 500,
      message: error.message
    });
  }
};

exports.validationMiddleware = validationMiddleware;
const userRegisterValidation = [(0, _expressValidator.check)('firstName').notEmpty().withMessage(errorMessage.required).isLength({
  min: 3
}).withMessage(errorMessage.minLength + ' 3 ' + errorMessage.minField), (0, _expressValidator.check)('lastName').optional().notEmpty().withMessage(errorMessage.required).isLength({
  min: 3
}).withMessage(errorMessage.minLength + ' 3 ' + errorMessage.minField), (0, _expressValidator.check)('phoneNo').notEmpty().withMessage(errorMessage.required).isLength({
  min: 10,
  max: 10
}).withMessage(errorMessage.minLength + ' 10 ' + errorMessage.minField).custom(value => {
  return _customer.default.findOne({
    phoneNo: value,
    isDeleted: false
  }).then(data => {
    if (data) {
      if (data.phoneNo === value) {
        throw new Error('Phone Number is already exist');
      }
    }
  });
}), (0, _expressValidator.check)('email').notEmpty().withMessage(errorMessage.required).isEmail().withMessage(errorMessage.email).custom(value => {
  return _customer.default.findOne({
    email: value,
    isDeleted: false
  }).then(data => {
    if (data) {
      if (data.emailVerified == false) {
        throw new Error('Email address is already exist please verify your email address');
      }

      if (data) {
        throw new Error('Email address is already exist');
      }
    }
  });
}), (0, _expressValidator.check)('password').notEmpty().withMessage(errorMessage.required).isStrongPassword({
  minLength: 8,
  minLowercase: 1,
  minUppercase: 1,
  minNumbers: 1,
  minSymbols: 1
}).withMessage('Please enter a strong password'), (0, _expressValidator.check)('confirm_password').notEmpty().withMessage(errorMessage.required).custom(async (value, {
  req
}) => {
  if (value !== req.body.password) {
    throw new Error('password and confirm password do not match');
  }
})];
exports.userRegisterValidation = userRegisterValidation;
const otpVerified = [(0, _expressValidator.check)('phoneNo').notEmpty().withMessage(errorMessage.required).isLength({
  min: 10,
  max: 10
}).withMessage(errorMessage.minLength + ' 10 ' + errorMessage.minField).custom(value => {
  return _customer.default.findOne({
    phoneNo: value,
    isDeleted: false
  }).then(data => {
    if (!data) {
      throw new Error('Phone number not match');
    }
  });
}), (0, _expressValidator.check)('otp').notEmpty().withMessage(errorMessage.required).isLength({
  min: 4,
  max: 4
}).custom(async (value, {
  req
}) => {
  return _customer.default.findOne({
    phoneNo: req.body.phoneNo,
    isDeleted: false,
    emailOtp: value
  }).then(data => {
    if (!data) {
      throw new Error('Please enter a valid otp');
    }
  });
})];
exports.otpVerified = otpVerified;
const userLoginMobileNumberValidation = [(0, _expressValidator.check)('phoneNo').notEmpty().withMessage(errorMessage.required).isLength({
  min: 10,
  max: 10
}).withMessage(errorMessage.minLength + ' 10 ' + errorMessage.minField).custom(value => {
  return _customer.default.findOne({
    phoneNo: value,
    isDeleted: false
  }).then(data => {
    if (!data) {
      throw new Error('Phone number not match');
    }
  });
}), (0, _expressValidator.check)('password').notEmpty().withMessage(errorMessage.required).custom(async (value, {
  req
}) => {
  return _customer.default.findOne({
    phoneNo: req.body.phoneNo,
    isDeleted: false
  }).then(async data => {
    if (data) {
      const password = await _bcryptjs.default.compare(req.body.password, data.password);

      if (!password) {
        throw new Error('please enter a valid password');
      }
    }
  });
})];
exports.userLoginMobileNumberValidation = userLoginMobileNumberValidation;
const userForgetPasswordValidation = [(0, _expressValidator.check)('phoneNo').notEmpty().withMessage(errorMessage.required).isLength({
  min: 10,
  max: 10
}).withMessage(errorMessage.minLength + ' 10 ' + errorMessage.minField).custom(value => {
  return _customer.default.findOne({
    phoneNo: value,
    isDeleted: false
  }).then(data => {
    if (!data) {
      throw new Error('Phone number not match');
    }
  });
}), (0, _expressValidator.check)('email').optional().isEmail().withMessage(errorMessage.email).custom(async (value, {
  req
}) => {
  return _customer.default.findOne({
    email: value
  }).then(data => {
    if (!data) {
      throw new Error('Email address is not exist');
    }
  });
})]; // old: payload.old,
// newPassword: payload.newPassword,
// confirmPassword: payload.confirmPassword

exports.userForgetPasswordValidation = userForgetPasswordValidation;
const chnagePasswordValidation = [(0, _expressValidator.check)('phoneNo').notEmpty().withMessage(errorMessage.required).isLength({
  min: 10,
  max: 10
}).withMessage(errorMessage.minLength + ' 10 ' + errorMessage.minField).custom(async value => {
  return _customer.default.findOne({
    phoneNo: value,
    isDeleted: false
  }).then(data => {
    if (!data) {
      throw new Error('Phone number not match');
    }
  });
}), (0, _expressValidator.check)('old_password').notEmpty().withMessage("This field is required").custom(async (value, {
  req
}) => {
  return _customer.default.findOne({
    phoneNo: req.body.phoneNo
  }).then(async data => {
    console.log(data, "???");

    if (!data) {
      throw new Error('Password not match');
    }

    if (data) {
      const password = await _bcryptjs.default.compare(value, data.password);
      console.log(password, "password");

      if (!password) {
        throw new Error('please enter a valid password');
      }
    } // if()

  });
}), (0, _expressValidator.check)('password').notEmpty().withMessage(errorMessage.required).isStrongPassword({
  minLength: 8,
  minLowercase: 1,
  minUppercase: 1,
  minNumbers: 1,
  minSymbols: 1
}).withMessage('Please enter a strong password'), (0, _expressValidator.check)('confirm_password').notEmpty().withMessage(errorMessage.required).custom(async (value, {
  req
}) => {
  if (value !== req.body.password) {
    throw new Error('password and confirm password do not match');
  }
})];
exports.chnagePasswordValidation = chnagePasswordValidation;
const profileUpdateValidation = [(0, _expressValidator.check)('phoneNo').notEmpty().withMessage(errorMessage.required).isLength({
  min: 10,
  max: 10
}).withMessage(errorMessage.minLength + ' 10 ' + errorMessage.minField).custom(async (value, {
  req
}) => {
  return _customer.default.findOne({
    _id: {
      $ne: req.userId
    },
    phoneNo: value,
    isDeleted: false
  }).then(data => {
    if (data) {
      throw new Error('Phone number already exists');
    }
  });
}), (0, _expressValidator.check)('email').notEmpty().withMessage(errorMessage.required).isEmail().withMessage(errorMessage.email).custom(async (value, {
  req
}) => {
  const data = await _customer.default.findOne({
    _id: {
      $ne: req.userId
    },
    email: value
  });

  if (data) {
    throw new Error('email  already exists');
  }
}), (0, _expressValidator.check)('gender').notEmpty().withMessage(errorMessage.required).isIn(['male', 'female', 'other'])];
exports.profileUpdateValidation = profileUpdateValidation;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tb2R1bGVzL2N1c3RvbWVycy91c2VyL3VzZXJWYWxpZGF0aW9ucy5qcyJdLCJuYW1lcyI6WyJlcnJvck1lc3NhZ2UiLCJyZXF1aXJlZCIsIm1pbkxlbmd0aCIsIm1pbkZpZWxkIiwiZW1haWwiLCJkYXRlVGltZSIsInZhbGlkYXRpb25NaWRkbGV3YXJlIiwicmVxIiwicmVzIiwibmV4dCIsImVycm9ycyIsImlzRW1wdHkiLCJzdGF0dXMiLCJqc29uIiwiYXJyYXkiLCJlcnJvciIsIm1lc3NhZ2UiLCJ1c2VyUmVnaXN0ZXJWYWxpZGF0aW9uIiwibm90RW1wdHkiLCJ3aXRoTWVzc2FnZSIsImlzTGVuZ3RoIiwibWluIiwib3B0aW9uYWwiLCJtYXgiLCJjdXN0b20iLCJ2YWx1ZSIsImN1c3RvbWVyTW9kZWwiLCJmaW5kT25lIiwicGhvbmVObyIsImlzRGVsZXRlZCIsInRoZW4iLCJkYXRhIiwiRXJyb3IiLCJpc0VtYWlsIiwiZW1haWxWZXJpZmllZCIsImlzU3Ryb25nUGFzc3dvcmQiLCJtaW5Mb3dlcmNhc2UiLCJtaW5VcHBlcmNhc2UiLCJtaW5OdW1iZXJzIiwibWluU3ltYm9scyIsImJvZHkiLCJwYXNzd29yZCIsIm90cFZlcmlmaWVkIiwiZW1haWxPdHAiLCJ1c2VyTG9naW5Nb2JpbGVOdW1iZXJWYWxpZGF0aW9uIiwiYmNyeXB0IiwiY29tcGFyZSIsInVzZXJGb3JnZXRQYXNzd29yZFZhbGlkYXRpb24iLCJjaG5hZ2VQYXNzd29yZFZhbGlkYXRpb24iLCJjb25zb2xlIiwibG9nIiwicHJvZmlsZVVwZGF0ZVZhbGlkYXRpb24iLCJfaWQiLCIkbmUiLCJ1c2VySWQiLCJpc0luIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7Ozs7QUFHQSxNQUFNQSxZQUFZLEdBQUc7QUFDakJDLEVBQUFBLFFBQVEsRUFBRSx1QkFETztBQUVqQkMsRUFBQUEsU0FBUyxFQUFFLDhCQUZNO0FBR2pCQyxFQUFBQSxRQUFRLEVB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WDRCLEVBaUI1Qiw2QkFBTSxRQUFOLEVBQWdCZCxRQUFoQixHQUEyQkMsV0FBM0IsQ0FBdUNuQixZQUFZLENBQUNDLFFBQXBELEVBQThEc0QsSUFBOUQsQ0FBbUUsQ0FBQyxNQUFELEVBQVEsUUFBUixFQUFpQixPQUFqQixDQUFuRSxDQWpCNEIsQ0FBaEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjaGVjaywgdmFsaWRhdGlvblJlc3VsdCB9IGZyb20gJ2V4cHJlc3MtdmFsaWRhdG9yJztcclxuaW1wb3J0IGN1c3RvbWVyTW9kZWwgZnJvbSAnLi4vLi4vLi4vZGF0YS1iYXNlL21vZGVscy9jdXN0b21lcic7XHJcbmltcG9ydCBiY3J5cHQgZnJvbSAnYmNyeXB0anMnXHJcblxyXG5cclxuY29uc3QgZXJyb3JNZXNzYWdlID0ge1xyXG4gICAgcmVxdWlyZWQ6ICdUaGUgZmllbGQgaXMgcmVxdWlyZWQnLFxyXG4gICAgbWluTGVuZ3RoOiAnVGhpcyBmaWVsZCBtdXN0IGJlIGF0IGxlYXN0ICcsXHJcbiAgICBtaW5GaWVsZDogJ2NoYXJhY3RlcnMnLFxyXG4gICAgZW1haWw6ICdQbGVhc2UgZW50ZXIgYSB2YWxpZCBlbWFpbCBhZGRyZXNzJyxcclxuICAgIGRhdGVUaW1lOiAnSW52YWxpZCBkYXRlIHRpbWUgZm9ybWF0JyxcclxuXHJcbn1cclxuY29uc3QgdmFsaWRhdGlvbk1pZGRsZXdhcmUgPSAocmVxLCByZXMsIG5leHQpID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgZXJyb3JzID0gdmFsaWRhdGlvblJlc3VsdChyZXEpO1xyXG4gICAgICAgIGlmICghZXJyb3JzLmlzRW1wdHkoKSkge1xyXG4gICAgICAgICAgICByZXMuc3RhdHVzKDQyMikuanNvbih7IGVycm9yczogZXJyb3JzLmFycmF5KCkgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBuZXh0KClcclxuICAgICAgICB9XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgc3RhdHVzOiA1MDAsIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfSlcclxuICAgIH1cclxufVxyXG5jb25zdCB1c2VyUmVnaXN0ZXJWYWxpZGF0aW9uID0gW1xyXG4gICAgY2hlY2soJ2ZpcnN0TmFtZScpLm5vdEVtcHR5KCkud2l0aE1lc3NhZ2UoZXJyb3JNZXNzYWdlLnJlcXVpcmVkKVxyXG4gICAgICAgIC5pc0xlbmd0aCh7IG1pbjogMyB9KS53aXRoTWVzc2FnZShlcnJvck1lc3NhZ2UubWluTGVuZ3RoICsgJyAzICcgKyBlcnJvck1lc3NhZ2UubWluRmllbGQpLFxyXG4gICAgY2hlY2soJ2xhc3ROYW1lJykub3B0aW9uYWwoKS5ub3RFbXB0eSgpLndpdGhNZXNzYWdlKGVycm9yTWVzc2FnZS5yZXF1aXJlZClcclxuICAgICAgICAuaXNMZW5ndGgoeyBtaW46IDMgfSkud2l0aE1lc3NhZ2UoZXJyb3JNZXNzYWdlLm1pbkxlbmd0aCArICcgMyAnICsgZXJyb3JNZXNzYWdlLm1pbkZpZWxkKSxcclxuICAgIGNoZWNrKCdwaG9uZU5vJykubm90RW1wdHkoKS53aXRoTWVzc2FnZShlcnJvck1lc3NhZ2UucmVxdWlyZWQpXHJcbiAgICAgICAgLmlzTGVuZ3RoKHsgbWluOiAxMCwgbWF4OiAxMCB9KS53aXRoTWVzc2FnZShlcnJvck1lc3NhZ2UubWluTGVuZ3RoICsgJyAxMCAnICsgZXJyb3JNZXNzYWdlLm1pbkZpZWxkKS5jdXN0b20oKHZhbHVlKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBjdXN0b21lck1vZGVsLmZpbmRPbmUoeyBwaG9uZU5vOiB2YWx1ZSwgaXNEZWxldGVkOiBmYWxzZSB9KS50aGVuKChkYXRhKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLnBob25lTm8gPT09IHZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUGhvbmUgTnVtYmVyIGlzIGFscmVhZHkgZXhpc3QnKVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSksXHJcbiAgICBjaGVjaygnZW1haWwnKS5ub3RFbXB0eSgpLndpdGhNZXNzYWdlKGVycm9yTWVzc2FnZS5yZXF1aXJlZCkuaXNFbWFpbCgpLndpdGhNZXNzYWdlKGVycm9yTWVzc2FnZS5lbWFpbCkuY3VzdG9tKCh2YWx1ZSkgPT4ge1xyXG4gICAgICAgIHJldHVybiBjdXN0b21lck1vZGVsLmZpbmRPbmUoeyBlbWFpbDogdmFsdWUsIGlzRGVsZXRlZDogZmFsc2UgfSkudGhlbigoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGRhdGEuZW1haWxWZXJpZmllZCA9PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRW1haWwgYWRkcmVzcyBpcyBhbHJlYWR5IGV4aXN0IHBsZWFzZSB2ZXJpZnkgeW91ciBlbWFpbCBhZGRyZXNzJylcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRW1haWwgYWRkcmVzcyBpcyBhbHJlYWR5IGV4aXN0JylcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9KVxyXG4gICAgfSksXHJcbiAgICBjaGVjaygncGFzc3dvcmQnKS5ub3RFbXB0eSgpLndpdGhNZXNzYWdlKGVycm9yTWVzc2FnZS5yZXF1aXJlZCkuaXNTdHJvbmdQYXNzd29yZCh7XHJcbiAgICAgICAgbWluTGVuZ3RoOiA4LFxyXG4gICAgICAgIG1pbkxvd2VyY2FzZTogMSxcclxuICAgICAgICBtaW5VcHBlcmNhc2U6IDEsXHJcbiAgICAgICAgbWluTnVtYmVyczogMSxcclxuICAgICAgICBtaW5TeW1ib2xzOiAxLFxyXG5cclxuICAgIH0pLndpdGhNZXNzYWdlKCdQbGVhc2UgZW50ZXIgYSBzdHJvbmcgcGFzc3dvcmQnKSxcclxuICAgIGNoZWNrKCdjb25maXJtX3Bhc3N3b3JkJykubm90RW1wdHkoKS53aXRoTWVzc2FnZShlcnJvck1lc3NhZ2UucmVxdWlyZWQpLmN1c3RvbShhc3luYyAodmFsdWUsIHsgcmVxIH0pID0+IHtcclxuICAgICAgICBpZiAodmFsdWUgIT09IHJlcS5ib2R5LnBhc3N3b3JkKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigncGFzc3dvcmQgYW5kIGNvbmZpcm0gcGFzc3dvcmQgZG8gbm90IG1hdGNoJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfSlcclxuXHJcblxyXG5dO1xyXG5cclxuXHJcbmNvbnN0IG90cFZlcmlmaWVkID0gW1xyXG4gICAgY2hlY2soJ3Bob25lTm8nKS5ub3RFbXB0eSgpLndpdGhNZXNzYWdlKGVycm9yTWVzc2FnZS5yZXF1aXJlZClcclxuICAgICAgICAuaXNMZW5ndGgoeyBtaW46IDEwLCBtYXg6IDEwIH0pLndpdGhNZXNzYWdlKGVycm9yTWVzc2FnZS5taW5MZW5ndGggKyAnIDEwICcgKyBlcnJvck1lc3NhZ2UubWluRmllbGQpLmN1c3RvbSgodmFsdWUpID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIGN1c3RvbWVyTW9kZWwuZmluZE9uZSh7IHBob25lTm86IHZhbHVlLCBpc0RlbGV0ZWQ6IGZhbHNlIH0pLnRoZW4oKGRhdGEpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICghZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUGhvbmUgbnVtYmVyIG5vdCBtYXRjaCcpXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pLFxyXG4gICAgY2hlY2soJ290cCcpLm5vdEVtcHR5KCkud2l0aE1lc3NhZ2UoZXJyb3JNZXNzYWdlLnJlcXVpcmVkKS5pc0xlbmd0aCh7IG1pbjogNCwgbWF4OiA0IH0pLmN1c3RvbShhc3luYyAodmFsdWUsIHsgcmVxIH0pID0+IHtcclxuICAgICAgICByZXR1cm4gY3VzdG9tZXJNb2RlbC5maW5kT25lKHsgcGhvbmVObzogcmVxLmJvZHkucGhvbmVObywgaXNEZWxldGVkOiBmYWxzZSwgZW1haWxPdHA6IHZhbHVlIH0pLnRoZW4oKGRhdGEpID0+IHtcclxuICAgICAgICAgICAgaWYgKCFkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1BsZWFzZSBlbnRlciBhIHZhbGlkIG90cCcpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgfSlcclxuXVxyXG5cclxuY29uc3QgdXNlckxvZ2luTW9iaWxlTnVtYmVyVmFsaWRhdGlvbiA9IFtcclxuICAgIGNoZWNrKCdwaG9uZU5vJykubm90RW1wdHkoKS53aXRoTWVzc2FnZShlcnJvck1lc3NhZ2UucmVxdWlyZWQpXHJcbiAgICAgICAgLmlzTGVuZ3RoKHsgbWluOiAxMCwgbWF4OiAxMCB9KS53aXRoTWVzc2FnZShlcnJvck1lc3NhZ2UubWluTGVuZ3RoICsgJyAxMCAnICsgZXJyb3JNZXNzYWdlLm1pbkZpZWxkKS5jdXN0b20oKHZhbHVlKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBjdXN0b21lck1vZGVsLmZpbmRPbmUoeyBwaG9uZU5vOiB2YWx1ZSwgaXNEZWxldGVkOiBmYWxzZSB9KS50aGVuKChkYXRhKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWRhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Bob25lIG51bWJlciBub3QgbWF0Y2gnKVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9KSxcclxuICAgIGNoZWNrKCdwYXNzd29yZCcpLm5vdEVtcHR5KCkud2l0aE1lc3NhZ2UoZXJyb3JNZXNzYWdlLnJlcXVpcmVkKS5jdXN0b20oYXN5bmMgKHZhbHVlLCB7IHJlcSB9KSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGN1c3RvbWVyTW9kZWwuZmluZE9uZSh7IHBob25lTm86IHJlcS5ib2R5LnBob25lTm8sIGlzRGVsZXRlZDogZmFsc2UgfSkudGhlbihhc3luYyAoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcGFzc3dvcmQgPSBhd2FpdCBiY3J5cHQuY29tcGFyZShyZXEuYm9keS5wYXNzd29yZCwgZGF0YS5wYXNzd29yZCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXBhc3N3b3JkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdwbGVhc2UgZW50ZXIgYSB2YWxpZCBwYXNzd29yZCcpXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgfSlcclxuXHJcbl1cclxuXHJcbmNvbnN0IHVzZXJGb3JnZXRQYXNzd29yZFZhbGlkYXRpb24gPSBbXHJcbiAgICBjaGVjaygncGhvbmVObycpLm5vdEVtcHR5KCkud2l0aE1lc3NhZ2UoZXJyb3JNZXNzYWdlLnJlcXVpcmVkKVxyXG4gICAgICAgIC5pc0xlbmd0aCh7IG1pbjogMTAsIG1heDogMTAgfSkud2l0aE1lc3NhZ2UoZXJyb3JNZXNzYWdlLm1pbkxlbmd0aCArICcgMTAgJyArIGVycm9yTWVzc2FnZS5taW5GaWVsZCkuY3VzdG9tKCh2YWx1ZSkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gY3VzdG9tZXJNb2RlbC5maW5kT25lKHsgcGhvbmVObzogdmFsdWUsIGlzRGVsZXRlZDogZmFsc2UgfSkudGhlbigoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQaG9uZSBudW1iZXIgbm90IG1hdGNoJylcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSksXHJcbiAgICBjaGVjaygnZW1haWwnKS5vcHRpb25hbCgpLmlzRW1haWwoKS53aXRoTWVzc2FnZShlcnJvck1lc3NhZ2UuZW1haWwpLmN1c3RvbShhc3luYyh2YWx1ZSwgeyByZXEgfSk9PntcclxuICAgICAgICByZXR1cm4gY3VzdG9tZXJNb2RlbC5maW5kT25lKHtlbWFpbDogdmFsdWV9KS50aGVuKChkYXRhKT0+e1xyXG4gICAgICAgICAgICBpZighZGF0YSl7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VtYWlsIGFkZHJlc3MgaXMgbm90IGV4aXN0JylcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICB9KVxyXG5dXHJcblxyXG4vLyBvbGQ6IHBheWxvYWQub2xkLFxyXG4vLyBuZXdQYXNzd29yZDogcGF5bG9hZC5uZXdQYXNzd29yZCxcclxuLy8gY29uZmlybVBhc3N3b3JkOiBwYXlsb2FkLmNvbmZpcm1QYXNzd29yZFxyXG5jb25zdCBjaG5hZ2VQYXNzd29yZFZhbGlkYXRpb24gPSBbXHJcbiAgICBjaGVjaygncGhvbmVObycpLm5vdEVtcHR5KCkud2l0aE1lc3NhZ2UoZXJyb3JNZXNzYWdlLnJlcXVpcmVkKVxyXG4gICAgICAgIC5pc0xlbmd0aCh7IG1pbjogMTAsIG1heDogMTAgfSkud2l0aE1lc3NhZ2UoZXJyb3JNZXNzYWdlLm1pbkxlbmd0aCArICcgMTAgJyArIGVycm9yTWVzc2FnZS5taW5GaWVsZCkuY3VzdG9tKGFzeW5jKHZhbHVlKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBjdXN0b21lck1vZGVsLmZpbmRPbmUoeyBwaG9uZU5vOiB2YWx1ZSwgaXNEZWxldGVkOiBmYWxzZSB9KS50aGVuKChkYXRhKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWRhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Bob25lIG51bWJlciBub3QgbWF0Y2gnKVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9KSxcclxuICAgIGNoZWNrKCdvbGRfcGFzc3dvcmQnKS5ub3RFbXB0eSgpLndpdGhNZXNzYWdlKFwiVGhpcyBmaWVsZCBpcyByZXF1aXJlZFwiKS5jdXN0b20oYXN5bmModmFsdWUseyByZXF9KT0+e1xyXG4gICAgICAgIHJldHVybiBjdXN0b21lck1vZGVsLmZpbmRPbmUoe3Bob25lTm86cmVxLmJvZHkucGhvbmVOb30pLnRoZW4oYXN5bmMoZGF0YSk9PntcclxuICAgICAgICAgICBjb25zb2xlLmxvZyhkYXRhLFwiPz8/XCIpO1xyXG4gICAgICAgICAgICBpZighZGF0YSl7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Bhc3N3b3JkIG5vdCBtYXRjaCcpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYoZGF0YSl7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXNzd29yZCA9IGF3YWl0IGJjcnlwdC5jb21wYXJlKHZhbHVlLCBkYXRhLnBhc3N3b3JkKTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHBhc3N3b3JkLFwicGFzc3dvcmRcIik7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXBhc3N3b3JkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdwbGVhc2UgZW50ZXIgYSB2YWxpZCBwYXNzd29yZCcpXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIFxyXG5cclxuICAgICAgICAgICAgLy8gaWYoKVxyXG4gICAgICAgIH0pXHJcbiAgICB9KSxcclxuICAgIGNoZWNrKCdwYXNzd29yZCcpLm5vdEVtcHR5KCkud2l0aE1lc3NhZ2UoZXJyb3JNZXNzYWdlLnJlcXVpcmVkKS5pc1N0cm9uZ1Bhc3N3b3JkKHtcclxuICAgICAgICBtaW5MZW5ndGg6IDgsXHJcbiAgICAgICAgbWluTG93ZXJjYXNlOiAxLFxyXG4gICAgICAgIG1pblVwcGVyY2FzZTogMSxcclxuICAgICAgICBtaW5OdW1iZXJzOiAxLFxyXG4gICAgICAgIG1pblN5bWJvbHM6IDEsXHJcblxyXG4gICAgfSkud2l0aE1lc3NhZ2UoJ1BsZWFzZSBlbnRlciBhIHN0cm9uZyBwYXNzd29yZCcpLFxyXG4gICAgY2hlY2soJ2NvbmZpcm1fcGFzc3dvcmQnKS5ub3RFbXB0eSgpLndpdGhNZXNzYWdlKGVycm9yTWVzc2FnZS5yZXF1aXJlZCkuY3VzdG9tKGFzeW5jICh2YWx1ZSwgeyByZXEgfSkgPT4ge1xyXG4gICAgICAgIGlmICh2YWx1ZSAhPT0gcmVxLmJvZHkucGFzc3dvcmQpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdwYXNzd29yZCBhbmQgY29uZmlybSBwYXNzd29yZCBkbyBub3QgbWF0Y2gnKTtcclxuICAgICAgICB9XHJcbiAgICB9KVxyXG5dO1xyXG5cclxuXHJcbmNvbnN0IHByb2ZpbGVVcGRhdGVWYWxpZGF0aW9uID0gW1xyXG4gICAgY2hlY2soJ3Bob25lTm8nKS5ub3RFbXB0eSgpLndpdGhNZXNzYWdlKGVycm9yTWVzc2FnZS5yZXF1aXJlZClcclxuICAgICAgICAuaXNMZW5ndGgoeyBtaW46IDEwLCBtYXg6IDEwIH0pLndpdGhNZXNzYWdlKGVycm9yTWVzc2FnZS5taW5MZW5ndGggKyAnIDEwICcgKyBlcnJvck1lc3NhZ2UubWluRmllbGQpLmN1c3RvbShhc3luYyh2YWx1ZSx7cmVxfSkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gY3VzdG9tZXJNb2RlbC5maW5kT25lKHsgX2lkOnskbmU6cmVxLnVzZXJJZH0sIHBob25lTm86IHZhbHVlLCBpc0RlbGV0ZWQ6IGZhbHNlIH0pLnRoZW4oKGRhdGEpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQaG9uZSBudW1iZXIgYWxyZWFkeSBleGlzdHMnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSksXHJcblxyXG4gICAgY2hlY2soJ2VtYWlsJykubm90RW1wdHkoKS53aXRoTWVzc2FnZShlcnJvck1lc3NhZ2UucmVxdWlyZWQpLmlzRW1haWwoKS53aXRoTWVzc2FnZShlcnJvck1lc3NhZ2UuZW1haWwpLmN1c3RvbShhc3luYyAodmFsdWUse3JlcX0pPT57XHJcbiAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IGN1c3RvbWVyTW9kZWwuZmluZE9uZSh7IF9pZDogeyAkbmU6IHJlcS51c2VySWQgfSwgZW1haWw6IHZhbHVlIH0pO1xyXG4gICAgICAgIGlmIChkYXRhKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignZW1haWwgIGFscmVhZHkgZXhpc3RzJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfSksXHJcbiAgICBjaGVjaygnZ2VuZGVyJykubm90RW1wdHkoKS53aXRoTWVzc2FnZShlcnJvck1lc3NhZ2UucmVxdWlyZWQpLmlzSW4oWydtYWxlJywnZmVtYWxlJywnb3RoZXInXSlcclxuXVxyXG5leHBvcnQge1xyXG4gICAgdmFsaWRhdGlvbk1pZGRsZXdhcmUsIHVzZXJSZWdpc3RlclZhbGlkYXRpb24sIFxyXG4gICAgb3RwVmVyaWZpZWQsIHVzZXJMb2dpbk1vYmlsZU51bWJlclZhbGlkYXRpb24sXHJcbiAgICB1c2VyRm9yZ2V0UGFzc3dvcmRWYWxpZGF0aW9uLGNobmFnZVBhc3N3b3JkVmFsaWRhdGlvbixwcm9maWxlVXBkYXRlVmFsaWRhdGlvblxyXG59XHJcblxyXG4iXX0=