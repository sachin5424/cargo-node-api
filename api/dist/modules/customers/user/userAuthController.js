"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.userRegister = exports.userOtpVerification = exports.userLoginWithMobile = exports.userForgetPassword = exports.profileUpdate = exports.profileDetails = exports.chnagePassword = void 0;

var _customer = _interopRequireDefault(require("../../../data-base/models/customer"));

var _jsonwebtoken = _interopRequireDefault(require("jsonwebtoken"));

var _bcryptjs = _interopRequireDefault(require("bcryptjs"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const userRegister = async (req, res) => {
  try {
    const payload = req.body;
    var otp = Math.floor(100000 + Math.random() * 900000);
    otp = 1234; //String(otp);
    // otp = otp.substring(0,4);
    // console.log( "valor:" +a );

    let options = {
      firstName: payload.firstName,
      phoneNo: payload.phoneNo,
      email: payload.email,
      password: payload.password,
      emailOtp: parseInt(otp)
    };
    let newData = new _customer.default(options);
    let data = await newData.save();
    return res.status(200).json({
      status: 200,
      message: 'success ',
      data: {
        username: data.firstName + ' ' + data.lastName,
        phoneNo: data.phoneNo,
        email: data.email
      }
    });
  } catch (error) {
    res.status(500).json({
      status: 500,
      error: error.message
    });
  }
};

exports.userRegister = userRegister;

const userOtpVerification = async (req, res) => {
  try {
    const payload = req.body;
    let options = {
      phoneNo: payload.phoneNo,
      otp: payload.otp
    };
    const user = await _customer.default.findOne(options);
    let userDetails = {};

    if (user) {
      userDetails['userId'] = user._id;
      userDetails['email'] = user.email || user.phoneNo;

      const token = _jsonwebtoken.default.sign(userDetails, 'testing', {
        expiresIn: '86765m'
      });

      return res.status(200).json({
        status: 200,
        message: "user login successfully",
        accessToken: token
      });
    }
  } catch (error) {
    return res.status(500).json({
      status: 500,
      message: error.message
    });
  }
};

exports.userOtpVerification = userOtpVerification;

const userLoginWithMobile = async (req, res) => {
  try {
    const payload = req.body;
    let option = {
      phoneNo: payload.phoneNo
    };
    const user = await _customer.default.findOne(option);
    let userDetails = {};

    if (user) {
      userDetails['userId'] = user._id;
      userDetails['email'] = user.email || user.phoneNo;

      const token = _jsonwebtoken.default.sign(userDetails, 'testing', {
        expiresIn: '86765m'
      });

      return res.status(200).json({
        status: 200,
        message: "user login successfully",
        accessToken: token
      });
    }
  } catch (error) {
    return res.status(500).json({
      status: 500,
      message: error.message
    });
  }
};

exports.userLoginWithMobile = userLoginWithMobile;

const userForgetPassword = async (req, res) => {
  try {
    const payload = req.body;
    let options = {
      phoneNo: payload.phoneNo
    };
    const user = await _customer.default.findOneAndUpdate(options, {
      emailOtp: "1234"
    });
    return res.status(200).json({
      status: 200,
      message: "otp sent"
    });
  } catch (error) {
    return res.status(500).json({
      status: 500,
      message: error.message
    });
  }
};

exports.userForgetPassword = userForgetPassword;

const chnagePassword = async (req, res) => {
  try {
    const payload = req.body;
    const salt = await _bcryptjs.default.genSalt(10);
    const password = await _bcryptjs.default.hash(payload.password, salt);
    await _customer.default.updateOne({
      phoneNo: payload.phoneNo
    }, {
      password
    });
    return res.status(200).json({
      status: 200,
      message: "password change successfully"
    });
  } catch (error) {
    return res.status(500).json({
      status: 500,
      message: error.message
    });
  }
};

exports.chnagePassword = chnagePassword;

const profileUpdate = async (req, res) => {
  try {
    const payload = req.body;
    const userId = req.userId;
    await _customer.default.updateOne({
      _id: userId
    }, payload);
    return res.status(200).json({
      status: 200,
      message: "profile updated successfully"
    });
  } catch (error) {
    return res.status(500).json({
      status: 500,
      message: error.message
    });
  }
};

exports.profileUpdate = profileUpdate;

const profileDetails = async (req, res) => {
  try {
    const data = await _customer.default.findOne({
      _id: req.userId
    }).select('email gender phoneNo');
    return res.status(200).json({
      status: 200,
      data
    });
  } catch (error) {
    return res.status(500).json({
      status: 500,
      message: error.message
    });
  }
};

exports.profileDetails = profileDetails;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tb2R1bGVzL2N1c3RvbWVycy91c2VyL3VzZXJBdXRoQ29udHJvbGxlci5qcyJdLCJuYW1lcyI6WyJ1c2VyUmVnaXN0ZXIiLCJyZXEiLCJyZXMiLCJwYXlsb2FkIiwiYm9keSIsIm90cCIsIk1hdGgiLCJmbG9vciIsInJhbmRvbSIsIm9wdGlvbnMiLCJmaXJzdE5hbWUiLCJwaG9uZU5vIiwiZW1haWwiLCJwYXNzd29yZCIsImVtYWlsT3RwIiwicGFyc2VJbnQiLCJuZXdEYXRhIiwiY3VzdG9tZXJNb2RlbCIsImRhdGEiLCJzYXZlIiwic3RhdHVzIiwianNvbiIsIm1lc3NhZ2UiLCJ1c2VybmFtZSIsImxhc3ROYW1lIiwiZXJyb3IiLCJ1c2VyT3RwVmVyaWZpY2F0aW9uIiwidXNlciIsImZpbmRPbmUiLCJ1c2VyRGV0YWlscyIsIl9pZCIsInRva2VuIiwiand0VG9rZW4iLCJzaWduIiwiZXhwaXJlc0luIiwiYWNjZXNzVG9rZW4iLCJ1c2VyTG9naW5XaXRoTW9iaWxlIiwib3B0aW9uIiwidXNlckZvcmdldFBhc3N3b3JkIiwiZmluZE9uZUFuZFVwZGF0ZSIsImNobmFnZVBhc3N3b3JkIiwic2FsdCIsImJjcnlwdCIsImdlblNhbHQiLCJoYXNoIiwidXBkYXRlT25lIiwicHJvZmlsZVVwZGF0ZSIsInVzZXJJZCIsInByb2ZpbGVEZXRhaWxzIiwic2VsZWN0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxZQUFZLEdBQUcsT0FBT0MsR0FBUCxFQUFZQyxHQUFaLEtBQW9CO0FBQ3JDLE1BQUk7QUFDQSxVQUFNQyxPQUFPLEdBQUdGLEdBQUcsQ0FBQ0csSUFBcEI7QUFDQSxRQUFJQyxHQUFHLEdBQUdDLElBQUksQ0FBQ0MsS0FBTCxDQUFXLFNBQVNELElBQUksQ0FBQ0UsTUFBTCxLQUFnQixNQUFwQyxDQUFWO0FBQ0FILElBQUFBLEdBQUcsR0FBRyxJQUFOLENBSEEsQ0FHVztBQUNYO0FB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QUFHLENBQUM4QztBQUFULEtBQXRCLEVBQXdDRSxNQUF4QyxDQUErQyxzQkFBL0MsQ0FBbkI7QUFDQSxXQUFPL0MsR0FBRyxDQUFDa0IsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCO0FBQUVELE1BQUFBLE1BQU0sRUFBQyxHQUFUO0FBQWFGLE1BQUFBO0FBQWIsS0FBckIsQ0FBUDtBQUNILEdBSEQsQ0FHRSxPQUFPTyxLQUFQLEVBQWM7QUFDWixXQUFPdkIsR0FBRyxDQUFDa0IsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCO0FBQUVELE1BQUFBLE1BQU0sRUFBRSxHQUFWO0FBQWVFLE1BQUFBLE9BQU8sRUFBRUcsS0FBSyxDQUFDSDtBQUE5QixLQUFyQixDQUFQO0FBQ0g7QUFDSixDQVBEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGN1c3RvbWVyTW9kZWwgZnJvbSAnLi4vLi4vLi4vZGF0YS1iYXNlL21vZGVscy9jdXN0b21lcic7XHJcbmltcG9ydCBqd3RUb2tlbiBmcm9tICdqc29ud2VidG9rZW4nXHJcbmltcG9ydCBiY3J5cHQgZnJvbSAnYmNyeXB0anMnXHJcblxyXG5jb25zdCB1c2VyUmVnaXN0ZXIgPSBhc3luYyAocmVxLCByZXMpID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgcGF5bG9hZCA9IHJlcS5ib2R5O1xyXG4gICAgICAgIHZhciBvdHAgPSBNYXRoLmZsb29yKDEwMDAwMCArIE1hdGgucmFuZG9tKCkgKiA5MDAwMDApO1xyXG4gICAgICAgIG90cCA9IDEyMzQ7Ly9TdHJpbmcob3RwKTtcclxuICAgICAgICAvLyBvdHAgPSBvdHAuc3Vic3RyaW5nKDAsNCk7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coIFwidmFsb3I6XCIgK2EgKTtcclxuICAgICAgICBsZXQgb3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgZmlyc3ROYW1lOiBwYXlsb2FkLmZpcnN0TmFtZSxcclxuICAgICAgICAgICAgcGhvbmVObzogcGF5bG9hZC5waG9uZU5vLFxyXG4gICAgICAgICAgICBlbWFpbDogcGF5bG9hZC5lbWFpbCxcclxuICAgICAgICAgICAgcGFzc3dvcmQ6IHBheWxvYWQucGFzc3dvcmQsXHJcbiAgICAgICAgICAgIGVtYWlsT3RwOiBwYXJzZUludChvdHApLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgbGV0IG5ld0RhdGEgPSBuZXcgY3VzdG9tZXJNb2RlbChvcHRpb25zKTtcclxuICAgICAgICBsZXQgZGF0YSA9IGF3YWl0IG5ld0RhdGEuc2F2ZSgpO1xyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbihcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAyMDAsXHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiAnc3VjY2VzcyAnLFxyXG4gICAgICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiBkYXRhLmZpcnN0TmFtZSArICcgJyArIGRhdGEubGFzdE5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgcGhvbmVObzogZGF0YS5waG9uZU5vLFxyXG4gICAgICAgICAgICAgICAgICAgIGVtYWlsOiBkYXRhLmVtYWlsLFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgKVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcbiAgICAgICAgICAgIHN0YXR1czogNTAwLFxyXG4gICAgICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZVxyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcbn1cclxuXHJcbmNvbnN0IHVzZXJPdHBWZXJpZmljYXRpb24gPSBhc3luYyAocmVxLCByZXMpID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgcGF5bG9hZCA9IHJlcS5ib2R5O1xyXG4gICAgICAgIGxldCBvcHRpb25zID0ge1xyXG4gICAgICAgICAgICBwaG9uZU5vOiBwYXlsb2FkLnBob25lTm8sXHJcbiAgICAgICAgICAgIG90cDogcGF5bG9hZC5vdHAsXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBjdXN0b21lck1vZGVsLmZpbmRPbmUob3B0aW9ucyk7XHJcbiAgICAgICAgbGV0IHVzZXJEZXRhaWxzID0ge31cclxuICAgICAgICBpZiAodXNlcikge1xyXG4gICAgICAgICAgICB1c2VyRGV0YWlsc1sndXNlcklkJ10gPSB1c2VyLl9pZDtcclxuICAgICAgICAgICAgdXNlckRldGFpbHNbJ2VtYWlsJ10gPSB1c2VyLmVtYWlsIHx8IHVzZXIucGhvbmVObztcclxuICAgICAgICAgICAgY29uc3QgdG9rZW4gPSBqd3RUb2tlbi5zaWduKHVzZXJEZXRhaWxzLCAndGVzdGluZycsIHtcclxuICAgICAgICAgICAgICAgIGV4cGlyZXNJbjogJzg2NzY1bSdcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgICAgICAgICAgICBzdGF0dXM6IDIwMCxcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwidXNlciBsb2dpbiBzdWNjZXNzZnVsbHlcIixcclxuICAgICAgICAgICAgICAgIGFjY2Vzc1Rva2VuOiB0b2tlbixcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7IHN0YXR1czogNTAwLCBtZXNzYWdlOiBlcnJvci5tZXNzYWdlIH0pXHJcbiAgICB9XHJcbn1cclxuXHJcblxyXG5jb25zdCB1c2VyTG9naW5XaXRoTW9iaWxlID0gYXN5bmMgKHJlcSwgcmVzKSA9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IHBheWxvYWQgPSByZXEuYm9keTtcclxuICAgICAgICBsZXQgb3B0aW9uID0ge1xyXG4gICAgICAgICAgICBwaG9uZU5vOiBwYXlsb2FkLnBob25lTm8sXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBjdXN0b21lck1vZGVsLmZpbmRPbmUob3B0aW9uKTtcclxuICAgICAgICBsZXQgdXNlckRldGFpbHMgPSB7fVxyXG4gICAgICAgIGlmKHVzZXIpe1xyXG4gICAgICAgICAgICB1c2VyRGV0YWlsc1sndXNlcklkJ10gPSB1c2VyLl9pZDtcclxuICAgICAgICAgICAgdXNlckRldGFpbHNbJ2VtYWlsJ10gPSB1c2VyLmVtYWlsIHx8IHVzZXIucGhvbmVObztcclxuICAgICAgICAgICAgY29uc3QgdG9rZW4gPSBqd3RUb2tlbi5zaWduKHVzZXJEZXRhaWxzLCAndGVzdGluZycsIHtcclxuICAgICAgICAgICAgICAgIGV4cGlyZXNJbjogJzg2NzY1bSdcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgICAgICAgICAgICBzdGF0dXM6IDIwMCxcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwidXNlciBsb2dpbiBzdWNjZXNzZnVsbHlcIixcclxuICAgICAgICAgICAgICAgIGFjY2Vzc1Rva2VuOiB0b2tlbixcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7IHN0YXR1czogNTAwLCBtZXNzYWdlOiBlcnJvci5tZXNzYWdlfSlcclxuICAgIH1cclxufVxyXG5cclxuXHJcbmNvbnN0ICB1c2VyRm9yZ2V0UGFzc3dvcmQgPSBhc3luYyAocmVxLCByZXMpID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgcGF5bG9hZCA9IHJlcS5ib2R5O1xyXG4gICAgICAgIGxldCBvcHRpb25zID0ge1xyXG4gICAgICAgICAgICBwaG9uZU5vOiBwYXlsb2FkLnBob25lTm8sXHJcbiAgICAgICAgICAgXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBjdXN0b21lck1vZGVsLmZpbmRPbmVBbmRVcGRhdGUob3B0aW9ucyx7ZW1haWxPdHA6XCIxMjM0XCJ9KTtcclxuICAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7c3RhdHVzOiAyMDAsIG1lc3NhZ2U6IFwib3RwIHNlbnRcIn0pXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7IHN0YXR1czogNTAwLCBtZXNzYWdlOiBlcnJvci5tZXNzYWdlfSlcclxuICAgIH1cclxufVxyXG5cclxuY29uc3QgY2huYWdlUGFzc3dvcmQgPSBhc3luYyAocmVxLHJlcykgPT57XHJcbiAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IHBheWxvYWQgPSByZXEuYm9keTtcclxuICAgICAgICBjb25zdCBzYWx0ID0gYXdhaXQgYmNyeXB0LmdlblNhbHQoMTApO1xyXG4gICAgICAgIGNvbnN0IHBhc3N3b3JkID0gYXdhaXQgYmNyeXB0Lmhhc2gocGF5bG9hZC5wYXNzd29yZCwgc2FsdCk7XHJcbiAgICAgICBhd2FpdCBjdXN0b21lck1vZGVsLnVwZGF0ZU9uZSh7cGhvbmVObzogcGF5bG9hZC5waG9uZU5vfSx7cGFzc3dvcmR9KVxyXG4gICAgICAgIFxyXG4gICAgICAgIFxyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7c3RhdHVzOiAyMDAsIG1lc3NhZ2U6XCJwYXNzd29yZCBjaGFuZ2Ugc3VjY2Vzc2Z1bGx5XCJ9KVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oeyBzdGF0dXM6IDUwMCwgbWVzc2FnZTogZXJyb3IubWVzc2FnZX0pXHJcbiAgICB9XHJcbn1cclxuXHJcblxyXG5jb25zdCBwcm9maWxlVXBkYXRlID0gYXN5bmMocmVxLCByZXMpID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgcGF5bG9hZCA9IHJlcS5ib2R5O1xyXG4gICAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VySWQ7XHJcbiAgICAgICAgYXdhaXQgY3VzdG9tZXJNb2RlbC51cGRhdGVPbmUoe19pZDogdXNlcklkfSwgcGF5bG9hZCk7XHJcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgc3RhdHVzOiAyMDAsIG1lc3NhZ2U6XCJwcm9maWxlIHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5XCJ9KVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oeyBzdGF0dXM6IDUwMCwgbWVzc2FnZTogZXJyb3IubWVzc2FnZX0pXHJcbiAgICB9XHJcbn1cclxuY29uc3QgcHJvZmlsZURldGFpbHMgPSBhc3luYyAocmVxLCByZXMpID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IGN1c3RvbWVyTW9kZWwuZmluZE9uZSh7X2lkOnJlcS51c2VySWR9KS5zZWxlY3QoJ2VtYWlsIGdlbmRlciBwaG9uZU5vJyk7XHJcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgc3RhdHVzOjIwMCxkYXRhfSlcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgc3RhdHVzOiA1MDAsIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2V9KVxyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQge1xyXG4gICAgdXNlclJlZ2lzdGVyLCB1c2VyT3RwVmVyaWZpY2F0aW9uLHVzZXJMb2dpbldpdGhNb2JpbGUsdXNlckZvcmdldFBhc3N3b3JkLGNobmFnZVBhc3N3b3JkLHByb2ZpbGVVcGRhdGUscHJvZmlsZURldGFpbHNcclxufSJdfQ==