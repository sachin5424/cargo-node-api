"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _expressValidator = require("express-validator");

var _permissionService = require("../../../services/permission-service");

var _index = require("../../../data-base/index");

var _test = require("../../../services/test");

var _mongoose = _interopRequireDefault(require("mongoose"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class PermissionController extends _permissionService.MongooseService {
  constructor() {
    super();
    this.userModelPermission = _index.UserAuthModelPermission;
  }

  static async get(req, res) {
    try {
      const getReq = req;
      const {
        model
      } = req.query;
      const temp = [];
      const check_admin = await _index.UserModel.findOne({
        _id: getReq.userId,
        isAdmin: true
      });

      if (check_admin) {
        const admin_permission = ["GET", "DELETE", "PUT", "POST"];
        return res.status(200).json({
          temp: [...temp, ...admin_permission]
        });
      }

      let test = [{
        $match: {
          userId: new _mongoose.default.Types.ObjectId(getReq.userId)
        }
      }, {
        $lookup: {
          from: "user_auth_permissions",
          localField: "permissionId",
          foreignField: "_id",
          as: "permission"
        }
      }, {
        $match: {
          "permission.model_name": model
        }
      }, {
        $project: {
          "permission.method": 1
        }
      }];
      const data = await (0, _test.aggregateFilter)(_index.UserAuthModelPermission, test);

      for (var i = 0; i < data.length; i++) {
        temp.push(data[i].permission[0].method);
      }

      res.status(200).json({
        data,
        temp
      });
    } catch (error) {
      return res.status(500).json({
        error
      });
    }
  }

  static async getPermission(req, res) {
    try {
      const data = await _index.UserAuthModelPermission.find();
      return res.status(200).json({
        data
      });
    } catch (error) {
      return res.status(500).json({
        error
      });
    }
  }

  static async addPermission(req, res) {
    try {
      const errors = (0, _expressValidator.validationResult)(req);

      if (!errors.isEmpty()) {
        res.status(422).json({
          message: errors.msg,
          errors: errors.errors
        });
      } else {
        let payload = req.body;
        const newData = new _index.UserAuthModelPermission(payload);
        await newData.save(); // await this.add(this.userModelPermission,payload);

        return res.status(200).json({
          message: "add permission"
        });
      }
    } catch (error) {
      return res.status(500).json({
        error: error
      });
    }
  }

  static async addMultiPermission(req, res) {
    try {
      const errors = (0, _expressValidator.validationResult)(req);

      if (!errors.isEmpty()) {
        res.status(422).json({
          message: errors.msg,
          errors: errors.errors
        });
      } else {
        let payload = req.body;
        let permissionList = req.body.permissionList;

        for (var i = 0; i < permissionList.length; i++) {
          const check_data = await this.userModelPermission.findOne({
            userId: permissionList[i].userId,
            permissionId: permissionList[i].permissionId
          });

          if (check_data) {
            return res.status(400).json({
              error: "err"
            });
          }
        }

        await this.userModelPermission.insertMany(payload.permissionList);
        return res.status(200).json({
          message: "add permission",
          payload
        });
      }
    } catch (error) {
      return res.status(500).json({
        error: error
      });
    }
  }

}

exports.default = PermissionController;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tb2R1bGVzL2FkbWluL3Blcm1pc3Npb24vUGVybWlzc2lvbkNvbnRyb2xsZXIuanMiXSwibmFtZXMiOlsiUGVybWlzc2lvbkNvbnRyb2xsZXIiLCJNb25nb29zZVNlcnZpY2UiLCJjb25zdHJ1Y3RvciIsInVzZXJNb2RlbFBlcm1pc3Npb24iLCJVc2VyQXV0aE1vZGVsUGVybWlzc2lvbiIsImdldCIsInJlcSIsInJlcyIsImdldFJlcSIsIm1vZGVsIiwicXVlcnkiLCJ0ZW1wIiwiY2hlY2tfYWRtaW4iLCJVc2VyTW9kZWwiLCJmaW5kT25lIiwiX2lkIiwidXNlcklkIiwiaXNBZG1pbiIsImFkbWluX3Blcm1pc3Npb24iLCJzdGF0dXMiLCJqc29uIiwidGVzdCIsIiRtYXRjaCIsIm1vbmdvb3NlIiwiVHlwZXMiLCJPYmplY3RJZCIsIiRsb29rdXAiLCJmcm9tIiwibG9jYWxGaWVsZCIsImZvcmVpZ25GaWVsZCIsImFzIiwiJHByb2plY3QiLCJkYXRhIiwiaSIsImxlbmd0aCIsInB1c2giLCJwZXJtaXNzaW9uIiwibWV0aG9kIiwiZXJyb3IiLCJnZXRQZXJtaXNzaW9uIiwiZmluZCIsImFkZFBlcm1pc3Npb24iLCJlcnJvcnMiLCJpc0VtcHR5IiwibWVzc2FnZSIsIm1zZyIsInBheWxvYWQiLCJib2R5IiwibmV3RGF0YSIsInNhdmUiLCJhZGRNdWx0aVBlcm1pc3Npb24iLCJwZXJtaXNzaW9uTGlzdCIsImNoZWNrX2RhdGEiLCJwZXJtaXNzaW9uSWQiLCJpbnNlcnRNYW55Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFHZSxNQUFNQSxvQkFBTixTQUFtQ0Msa0NBQW5DLENBQW1EO0FBQzlEQyxFQUFBQSxXQUFXLEdBQUc7QUFDVjtBQUNBLFNBQUtDLG1CQUFMLEdBQTJCQyw4QkFBM0I7QUFDSDs7QUFFZSxlQUFIQyxHQUFHLENBQUNDLEdBQUQsRUFBTUMsR0FBTixFQUFXO0FB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QWxCO0FBQ0EsWUFBSUksY0FBYyxHQUFHN0MsR0FBRyxDQUFDeUMsSUFBSixDQUFTSSxjQUE5Qjs7QUFDQSxhQUFLLElBQUlsQixDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHa0IsY0FBYyxDQUFDakIsTUFBbkMsRUFBMkNELENBQUMsRUFBNUMsRUFBZ0Q7QUFDNUMsZ0JBQU1tQixVQUFVLEdBQUcsTUFBTSxLQUFLakQsbUJBQUwsQ0FBeUJXLE9BQXpCLENBQWlDO0FBQUVFLFlBQUFBLE1BQU0sRUFBRW1DLGNBQWMsQ0FBQ2xCLENBQUQsQ0FBZCxDQUFrQmpCLE1BQTVCO0FBQW9DcUMsWUFBQUEsWUFBWSxFQUFFRixjQUFjLENBQUNsQixDQUFELENBQWQsQ0FBa0JvQjtBQUFwRSxXQUFqQyxDQUF6Qjs7QUFDQSxjQUFJRCxVQUFKLEVBQWdCO0FBQ1osbUJBQU83QyxHQUFHLENBQUNZLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQjtBQUFFa0IsY0FBQUEsS0FBSyxFQUFFO0FBQVQsYUFBckIsQ0FBUDtBQUNIO0FBQ0o7O0FBQ0QsY0FBTSxLQUFLbkMsbUJBQUwsQ0FBeUJtRCxVQUF6QixDQUFvQ1IsT0FBTyxDQUFDSyxjQUE1QyxDQUFOO0FBQ0EsZUFBTzVDLEdBQUcsQ0FBQ1ksTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCO0FBQUV3QixVQUFBQSxPQUFPLEVBQUUsZ0JBQVg7QUFBNkJFLFVBQUFBO0FBQTdCLFNBQXJCLENBQVA7QUFDSDtBQUNKLEtBcEJELENBcUJBLE9BQU9SLEtBQVAsRUFBYztBQUNWLGFBQU8vQixHQUFHLENBQUNZLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQjtBQUFFa0IsUUFBQUEsS0FBSyxFQUFFQTtBQUFULE9BQXJCLENBQVA7QUFDSDtBQUNKOztBQXhHNkQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB2YWxpZGF0aW9uUmVzdWx0IH0gZnJvbSAnZXhwcmVzcy12YWxpZGF0b3InO1xyXG5pbXBvcnQgeyBNb25nb29zZVNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlcy9wZXJtaXNzaW9uLXNlcnZpY2UnO1xyXG5pbXBvcnQgeyBVc2VyQXV0aFBlcm1pc3Npb24sIFVzZXJBdXRoTW9kZWxQZXJtaXNzaW9uLCBVc2VyTW9kZWwgfSBmcm9tICcuLi8uLi8uLi9kYXRhLWJhc2UvaW5kZXgnO1xyXG5pbXBvcnQgeyBhZ2dyZWdhdGVGaWx0ZXIgfSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlcy90ZXN0JztcclxuaW1wb3J0IG1vbmdvb3NlIGZyb20gJ21vbmdvb3NlJztcclxuXHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQZXJtaXNzaW9uQ29udHJvbGxlciBleHRlbmRzIE1vbmdvb3NlU2VydmljZSB7XHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgIHRoaXMudXNlck1vZGVsUGVybWlzc2lvbiA9IFVzZXJBdXRoTW9kZWxQZXJtaXNzaW9uO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBzdGF0aWMgYXN5bmMgZ2V0KHJlcSwgcmVzKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgZ2V0UmVxID0gcmVxO1xyXG4gICAgICAgICAgICBjb25zdCB7IG1vZGVsIH0gPSByZXEucXVlcnk7XHJcbiAgICAgICAgICAgIGNvbnN0IHRlbXAgPSBbXTtcclxuICAgICAgICAgICAgY29uc3QgY2hlY2tfYWRtaW4gPSBhd2FpdCBVc2VyTW9kZWwuZmluZE9uZSh7IF9pZDogZ2V0UmVxLnVzZXJJZCwgaXNBZG1pbjogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgaWYgKGNoZWNrX2FkbWluKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhZG1pbl9wZXJtaXNzaW9uID0gW1wiR0VUXCIsIFwiREVMRVRFXCIsIFwiUFVUXCIsIFwiUE9TVFwiXTtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7IHRlbXA6IFsuLi50ZW1wLCAuLi5hZG1pbl9wZXJtaXNzaW9uXSB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXQgdGVzdCA9IFtcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAkbWF0Y2g6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlcklkOiBuZXcgbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQoZ2V0UmVxLnVzZXJJZClcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICRsb29rdXA6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZnJvbTogXCJ1c2VyX2F1dGhfcGVybWlzc2lvbnNcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxGaWVsZDogXCJwZXJtaXNzaW9uSWRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWlnbkZpZWxkOiBcIl9pZFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhczogXCJwZXJtaXNzaW9uXCJcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgeyAkbWF0Y2g6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgXCJwZXJtaXNzaW9uLm1vZGVsX25hbWVcIjogbW9kZWxcclxuICAgICAgICAgICAgICAgICAgICB9IH0sXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgJHByb2plY3Q6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgXCJwZXJtaXNzaW9uLm1ldGhvZFwiOiAxXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBdO1xyXG4gICAgICAgICAgICBjb25zdCBkYXRhID0gYXdhaXQgYWdncmVnYXRlRmlsdGVyKFVzZXJBdXRoTW9kZWxQZXJtaXNzaW9uLCB0ZXN0KTtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wLnB1c2goZGF0YVtpXS5wZXJtaXNzaW9uWzBdLm1ldGhvZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oeyBkYXRhLCB0ZW1wIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3IgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgc3RhdGljIGFzeW5jIGdldFBlcm1pc3Npb24ocmVxLCByZXMpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBkYXRhID0gYXdhaXQgVXNlckF1dGhNb2RlbFBlcm1pc3Npb24uZmluZCgpO1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmpzb24oeyBkYXRhIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3IgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgc3RhdGljIGFzeW5jIGFkZFBlcm1pc3Npb24ocmVxLCByZXMpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBlcnJvcnMgPSB2YWxpZGF0aW9uUmVzdWx0KHJlcSk7XHJcbiAgICAgICAgICAgIGlmICghZXJyb3JzLmlzRW1wdHkoKSkge1xyXG4gICAgICAgICAgICAgICAgcmVzLnN0YXR1cyg0MjIpLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9ycy5tc2csXHJcbiAgICAgICAgICAgICAgICAgICAgZXJyb3JzOiBlcnJvcnMuZXJyb3JzXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGxldCBwYXlsb2FkID0gcmVxLmJvZHk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdEYXRhID0gbmV3IFVzZXJBdXRoTW9kZWxQZXJtaXNzaW9uKHBheWxvYWQpO1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgbmV3RGF0YS5zYXZlKCk7XHJcbiAgICAgICAgICAgICAgICAvLyBhd2FpdCB0aGlzLmFkZCh0aGlzLnVzZXJNb2RlbFBlcm1pc3Npb24scGF5bG9hZCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmpzb24oeyBtZXNzYWdlOiBcImFkZCBwZXJtaXNzaW9uXCIgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiBlcnJvciB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBzdGF0aWMgYXN5bmMgYWRkTXVsdGlQZXJtaXNzaW9uKHJlcSwgcmVzKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgZXJyb3JzID0gdmFsaWRhdGlvblJlc3VsdChyZXEpO1xyXG4gICAgICAgICAgICBpZiAoIWVycm9ycy5pc0VtcHR5KCkpIHtcclxuICAgICAgICAgICAgICAgIHJlcy5zdGF0dXMoNDIyKS5qc29uKHtcclxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBlcnJvcnMubXNnLFxyXG4gICAgICAgICAgICAgICAgICAgIGVycm9yczogZXJyb3JzLmVycm9yc1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgcGF5bG9hZCA9IHJlcS5ib2R5O1xyXG4gICAgICAgICAgICAgICAgbGV0IHBlcm1pc3Npb25MaXN0ID0gcmVxLmJvZHkucGVybWlzc2lvbkxpc3Q7XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBlcm1pc3Npb25MaXN0Lmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hlY2tfZGF0YSA9IGF3YWl0IHRoaXMudXNlck1vZGVsUGVybWlzc2lvbi5maW5kT25lKHsgdXNlcklkOiBwZXJtaXNzaW9uTGlzdFtpXS51c2VySWQsIHBlcm1pc3Npb25JZDogcGVybWlzc2lvbkxpc3RbaV0ucGVybWlzc2lvbklkIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjaGVja19kYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiBcImVyclwiIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMudXNlck1vZGVsUGVybWlzc2lvbi5pbnNlcnRNYW55KHBheWxvYWQucGVybWlzc2lvbkxpc3QpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgbWVzc2FnZTogXCJhZGQgcGVybWlzc2lvblwiLCBwYXlsb2FkIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogZXJyb3IgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcbiJdfQ==