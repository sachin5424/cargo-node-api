"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _mongoose = _interopRequireDefault(require("mongoose"));

var _fareManagement = _interopRequireDefault(require("../data-base/models/fareManagement"));

var _serviceType = _interopRequireDefault(require("../data-base/models/serviceType"));

var _helper = require("../utls/_helper");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class Service {
  static async listFareManagemengt(query, params) {
    const isAll = params.isAll === 'ALL';
    const response = {
      statusCode: 400,
      message: 'Data not found!',
      result: {
        data: [],
        page: query.page * 1 > 0 ? query.page * 1 : 1,
        limit: query.limit * 1 > 0 ? query.limit * 1 : 20,
        total: 0
      },
      status: false
    };

    try {
      const serviceType = await _serviceType.default.findOne({
        key: query?.serviceTypeKey
      });

      const search = _objectSpread({
        _id: query._id,
        isDeleted: false,
        serviceType: serviceType?._id,
        rideType: query.rideType ? _mongoose.default.Types.ObjectId(query.rideType) : ''
      }, (0, _helper.getAdminFilter)());

      (0, _helper.clearSearch)(search);
      const $aggregate = [{
        $match: search
      }, {
        $sort: {
          _id: -1
        }
      }, {
        $lookup: {
          from: 'servicetypes',
          localField: 'serviceType',
          foreignField: '_id',
          as: 'serviceTypeDetails',
          pipeline: [{
            $project: {
              name: 1
            }
          }]
        }
      }, {
        $unwind: "$serviceTypeDetails"
      }, {
        $lookup: {
          from: 'ridetypes',
          localField: 'rideType',
          foreignField: '_id',
          as: 'rideTypeDetails',
          pipeline: [{
            $project: {
              name: 1
            }
          }]
        }
      }, {
        $unwind: "$rideTypeDetails"
      }, {
        $lookup: {
          from: 'vehiclecategories',
          localField: 'vehicleCategory',
          foreignField: '_id',
          as: 'vehicleCategoryDetails',
          pipeline: [{
            $project: {
              name: 1
            }
          }]
        }
      }, {
        $unwind: "$vehicleCategoryDetails"
      }, {
        $lookup: {
          from: 'states',
          localField: 'state',
          foreignField: '_id',
          as: 'stateDetails',
          pipeline: [{
            $project: {
              name: 1
            }
          }]
        }
      }, {
        $unwind: "$stateDetails"
      }, {
        $lookup: {
          from: 'districts',
          localField: 'district',
          foreignField: '_id',
          as: 'districtDetails',
          pipeline: [{
            $project: {
              name: 1
            }
          }]
        }
      }, {
        $unwind: "$districtDetails"
      }, {
        $lookup: {
          from: 'taluks',
          localField: 'taluk',
          foreignField: '_id',
          as: 'talukDetails',
          pipeline: [{
            $project: {
              name: 1
            }
          }]
        }
      }, {
        $unwind: "$talukDetails"
      }, {
        "$project": {
          serviceType: 1,
          rideType: 1,
          vehicleCategory: 1,
          state: 1,
          district: 1,
          taluk: 1,
          baseFare: 1,
          bookingFare: 1,
          perMinuteFare: 1,
          cancelCharge: 1,
          waitingCharge: 1,
          adminCommissionType: 1,
          adminCommissionValue: 1,
          perKMCharges: 1,
          serviceTypeDetails: 1,
          rideTypeDetails: 1,
          vehicleCategoryDetails: 1,
          stateDetails: 1,
          districtDetails: 1,
          talukDetails: 1
        }
      }];
      const counter = await _fareManagement.default.aggregate([...$aggregate, {
        $count: "total"
      }]);
      response.result.total = counter[0]?.total;

      if (isAll) {
        response.result.page = 1;
        response.result.limit = response.result.total;
      }

      response.result.data = await _fareManagement.default.aggregate([...$aggregate, {
        $limit: response.result.limit + response.result.limit * (response.result.page - 1)
      }, {
        $skip: response.result.limit * (response.result.page - 1)
      }]);

      if (response.result.data.length) {
        response.message = "Data fetched";
      }

      response.statusCode = 200;
      response.status = true;
      return response;
    } catch (e) {
      throw new Error(e);
    }
  }

  static async saveFareManagemengt(data) {
    const _id = data._id;
    const response = {
      statusCode: 400,
      message: 'Error!',
      status: false
    };

    try {
      const tplData = _id ? await _fareManagement.default.findById(_id) : new _fareManagement.default();
      tplData.serviceType = data.serviceType;
      tplData.rideType = data.rideType;
      tplData.vehicleCategory = data.vehicleCategory;
      tplData.state = data.state;
      tplData.district = data.district;
      tplData.taluk = data.taluk;
      tplData.baseFare = data.baseFare;
      tplData.bookingFare = data.bookingFare;
      tplData.perMinuteFare = data.perMinuteFare;
      tplData.cancelCharge = data.cancelCharge;
      tplData.waitingCharge = data.waitingCharge;
      tplData.adminCommissionType = data.adminCommissionType;
      tplData.adminCommissionValue = data.adminCommissionValue;
      tplData.perKMCharges = data.perKMCharges;
      await tplData.save();
      response.message = _id ? "Fare management is Updated" : "A new fare management is created";
      response.statusCode = 200;
      response.status = true;
      return response;
    } catch (e) {
      throw new Error(e);
    }
  }

  static async deleteFareManagemengt(_id, cond) {
    cond = !cond ? {} : cond;
    const response = {
      statusCode: 400,
      message: 'Error!',
      status: false
    };

    try {
      await _fareManagement.default.updateOne(_objectSpread({
        _id
      }, cond), {
        isDeleted: true
      });
      response.message = "Deleted successfully";
      response.statusCode = 200;
      response.status = true;
      return response;
    } catch (e) {
      throw new Error("Can not delete. Something went wrong.");
    }
  }

  static async deleteFareManagemengtPermanent(_id, cond) {
    cond = !cond ? {} : cond;
    const response = {
      statusCode: 400,
      message: 'Error!',
      status: false
    };

    try {
      await _fareManagement.default.deleteOne(_objectSpread({
        _id
      }, cond));
      response.message = "Deleted successfully";
      response.statusCode = 200;
      response.status = true;
      return response;
    } catch (e) {
      throw new Error("Can not delete. Something went wrong.");
    }
  }

}

exports.default = Service;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2aWNlcy9GYXJlTWFuYWdlbWVudFNlcnZpY2UuanMiXSwibmFtZXMiOlsiU2VydmljZSIsImxpc3RGYXJlTWFuYWdlbWVuZ3QiLCJxdWVyeSIsInBhcmFtcyIsImlzQWxsIiwicmVzcG9uc2UiLCJzdGF0dXNDb2RlIiwibWVzc2FnZSIsInJlc3VsdCIsImRhdGEiLCJwYWdlIiwibGltaXQiLCJ0b3RhbCIsInN0YXR1cyIsInNlcnZpY2VUeXBlIiwiU2VydmljZVR5cGVNb2RlbCIsImZpbmRPbmUiLCJrZXkiLCJzZXJ2aWNlVHlwZUtleSIsInNlYXJjaCIsIl9pZCIsImlzRGVsZXRlZCIsInJpZGVUeXBlIiwibW9uZ29vc2UiLCJUeXBlcyIsIk9iamVjdElkIiwiJGFnZ3JlZ2F0ZSIsIiRtYXRjaCIsIiRzb3J0IiwiJGxvb2t1cCIsImZyb20iLCJsb2NhbEZpZWxkIiwiZm9yZWlnbkZpZWxkIiwiYXMiLCJwaXBlbGluZSIsIiRwcm9qZWN0IiwibmFtZSIsIiR1bndpbmQiLCJ2ZWhpY2xlQ2F0ZWdvcnkiLCJzdGF0ZSIsImRpc3RyaWN0IiwidGFsdWsiLCJiYXNlRmFyZSIsImJvb2tpbmdGYXJlIiwicGVyTWludXRlRmFyZSIsImNhbmNlbENoYXJnZSIsIndhaXRpbmdDaGFyZ2UiLCJhZG1pbkNvbW1pc3Npb25UeXBlIiwiYWRtaW5Db21taXNzaW9uVmFsdWUiLCJwZXJLTUNoYXJnZXMiLCJzZXJ2aWNlVHlwZURldGFpbHMiLCJyaWRlVHlwZURldGFpbHMiLCJ2ZWhpY2xlQ2F0ZWdvcnlEZXRhaWxzIiwic3RhdGVEZXRhaWxzIiwiZGlzdHJpY3REZXRhaWxzIiwidGFsdWtEZXRhaWxzIiwiY291bnRlciIsIkZhcmVNYW5hZ2VtZW50TW9kZWwiLCJhZ2dyZWdhdGUiLCIkY291bnQiLCIkbGltaXQiLCIkc2tpcCIsImxlbmd0aCIsImUiLCJFcnJvciIsInNhdmVGYXJlTWFuYWdlbWVuZ3QiLCJ0cGxEYXRhIiwiZmluZEJ5SWQiLCJzYXZlIiwiZGVsZXRlRmFyZU1hbmFnZW1lbmd0IiwiY29uZCIsInVwZGF0ZU9uZSIsImRlbGV0ZUZhcmVNYW5hZ2VtZW5ndFBlcm1hbmVudCIsImRlbGV0ZU9uZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7Ozs7O0FBRWUsTUFBTUEsT0FBTixDQUFjO0FBQ08sZUFBbkJDLG1CQUFtQixDQUFDQyxLQUFELEVBQVFDLE1BQVIsRUFBZ0I7QUFDNUMsVUFBTUMsS0FBSyxHQUFHRCxNQUFNLENBQUNDLEtBQVAsS0FBaUIsS0FBL0I7QUFDQSxVQUFNQyxRQUFRLEdBQUc7QUFDYkMsTUFBQUEsVUFBVSxFQUFFLEdBREM7QUFFYkMsTUFBQUEsT0FBTyxFQUFFLGlCQUZJO0FBR2JDLE1BQUFBLE1BQU0sRUFBRTtBQUNKQyxRQUFBQSxJQUFJLEVBQUUsRUFERjtBQUVKQyxRQUFBQSxJQUFJLEVBQUVSLEtBQUssQ0FBQ1EsSUFBTixHQUFhLENBQWIsR0FBaUIsQ0FBakIsR0FBcUJSLEtBQUssQ0FBQ1EsSUFBTixHQUFhLENBQWxDLEdBQXNDLENBRnhDO0FBR0pDLFFBQUFBLEtBQUssRUFBRVQsS0FBSyxDQUFDUyxLQUFOLEdBQWMsQ0FBZCxHQUFrQixDQUFsQixHQUFzQlQsS0FBSyxDQUFDUyxLQUFOLEdBQWMsQ0FBcEMsR0FBd0MsRUFIM0M7QUFJSkMsUUFBQUEsS0FBSyxFQUFFO0FBSkgsT0FISztBQVNiQyxNQUFBQSxNQUFNLEVBQUU7QUFUSyxLQUFqQjs7QUFZQSxRQUFJO0FBQ0EsWUFBTUMsV0FBVyxHQUFHLE1BQU1DLHFCQUFpQkMsT0FBakIsQ0FBeUI7QUFBQ0MsUUFBQUEsR0FBRyxFQUFFZixLQUFLLEVBQUVnQjtBQUFiLE9BQXpCLENBQTFCOztBQUVBLFlBQU1DLE1BQU07QUFDUkMsUUFBQUEsR0FBRyxFQUFFbEIsS0FBSyxDQUFDa0IsR0FESDtBQUVSQyxRQUFBQSxTQUFTLEVBQUUsS0FGSDtBQUdSUCxRQUFBQSxXQUFXLEVBQUVBLFdBQVcsRUFBRU0sR0FIbEI7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UUUsT0FBTzBELENBQVAsRUFBVTtBQUNSLFlBQU0sSUFBSUMsS0FBSixDQUFVLHVDQUFWLENBQU47QUFDSDtBQUNKOztBQUMwQyxlQUE5QlEsOEJBQThCLENBQUNwRCxHQUFELEVBQU1rRCxJQUFOLEVBQVk7QUFDbkRBLElBQUFBLElBQUksR0FBRyxDQUFDQSxJQUFELEdBQVEsRUFBUixHQUFhQSxJQUFwQjtBQUNBLFVBQU1qRSxRQUFRLEdBQUc7QUFBRUMsTUFBQUEsVUFBVSxFQUFFLEdBQWQ7QUFBbUJDLE1BQUFBLE9BQU8sRUFBRSxRQUE1QjtBQUFzQ00sTUFBQUEsTUFBTSxFQUFFO0FBQTlDLEtBQWpCOztBQUVBLFFBQUk7QUFDQSxZQUFNNEMsd0JBQW9CZ0IsU0FBcEI7QUFBZ0NyRCxRQUFBQTtBQUFoQyxTQUF3Q2tELElBQXhDLEVBQU47QUFFQWpFLE1BQUFBLFFBQVEsQ0FBQ0UsT0FBVCxHQUFtQixzQkFBbkI7QUFDQUYsTUFBQUEsUUFBUSxDQUFDQyxVQUFULEdBQXNCLEdBQXRCO0FBQ0FELE1BQUFBLFFBQVEsQ0FBQ1EsTUFBVCxHQUFrQixJQUFsQjtBQUNBLGFBQU9SLFFBQVA7QUFFSCxLQVJELENBUUUsT0FBTzBELENBQVAsRUFBVTtBQUNSLFlBQU0sSUFBSUMsS0FBSixDQUFVLHVDQUFWLENBQU47QUFDSDtBQUNKOztBQXBQd0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbW9uZ29vc2UgZnJvbSBcIm1vbmdvb3NlXCI7XHJcbmltcG9ydCBGYXJlTWFuYWdlbWVudE1vZGVsIGZyb20gXCIuLi9kYXRhLWJhc2UvbW9kZWxzL2ZhcmVNYW5hZ2VtZW50XCI7XHJcbmltcG9ydCBTZXJ2aWNlVHlwZU1vZGVsIGZyb20gXCIuLi9kYXRhLWJhc2UvbW9kZWxzL3NlcnZpY2VUeXBlXCI7XHJcbmltcG9ydCB7IGNsZWFyU2VhcmNoLCBnZXRBZG1pbkZpbHRlciB9IGZyb20gXCIuLi91dGxzL19oZWxwZXJcIjtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNlcnZpY2Uge1xyXG4gICAgc3RhdGljIGFzeW5jIGxpc3RGYXJlTWFuYWdlbWVuZ3QocXVlcnksIHBhcmFtcykge1xyXG4gICAgICAgIGNvbnN0IGlzQWxsID0gcGFyYW1zLmlzQWxsID09PSAnQUxMJztcclxuICAgICAgICBjb25zdCByZXNwb25zZSA9IHtcclxuICAgICAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxyXG4gICAgICAgICAgICBtZXNzYWdlOiAnRGF0YSBub3QgZm91bmQhJyxcclxuICAgICAgICAgICAgcmVzdWx0OiB7XHJcbiAgICAgICAgICAgICAgICBkYXRhOiBbXSxcclxuICAgICAgICAgICAgICAgIHBhZ2U6IHF1ZXJ5LnBhZ2UgKiAxID4gMCA/IHF1ZXJ5LnBhZ2UgKiAxIDogMSxcclxuICAgICAgICAgICAgICAgIGxpbWl0OiBxdWVyeS5saW1pdCAqIDEgPiAwID8gcXVlcnkubGltaXQgKiAxIDogMjAsXHJcbiAgICAgICAgICAgICAgICB0b3RhbDogMCxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgc3RhdHVzOiBmYWxzZVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNlcnZpY2VUeXBlID0gYXdhaXQgU2VydmljZVR5cGVNb2RlbC5maW5kT25lKHtrZXk6IHF1ZXJ5Py5zZXJ2aWNlVHlwZUtleX0pO1xyXG5cclxuICAgICAgICAgICAgY29uc3Qgc2VhcmNoID0ge1xyXG4gICAgICAgICAgICAgICAgX2lkOiBxdWVyeS5faWQsXHJcbiAgICAgICAgICAgICAgICBpc0RlbGV0ZWQ6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgc2VydmljZVR5cGU6IHNlcnZpY2VUeXBlPy5faWQsXHJcbiAgICAgICAgICAgICAgICByaWRlVHlwZTogcXVlcnkucmlkZVR5cGUgPyBtb25nb29zZS5UeXBlcy5PYmplY3RJZChxdWVyeS5yaWRlVHlwZSkgOiAnJyxcclxuICAgICAgICAgICAgICAgIC4uLmdldEFkbWluRmlsdGVyKClcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIGNsZWFyU2VhcmNoKHNlYXJjaCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCAkYWdncmVnYXRlID0gW1xyXG4gICAgICAgICAgICAgICAgeyAkbWF0Y2g6IHNlYXJjaCB9LFxyXG4gICAgICAgICAgICAgICAgeyAkc29ydDogeyBfaWQ6IC0xIH0gfSxcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAkbG9va3VwOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZyb206ICdzZXJ2aWNldHlwZXMnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2NhbEZpZWxkOiAnc2VydmljZVR5cGUnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3JlaWduRmllbGQ6ICdfaWQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhczogJ3NlcnZpY2VUeXBlRGV0YWlscycsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBpcGVsaW5lOiBbXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHByb2plY3Q6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogMVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB7ICR1bndpbmQ6IFwiJHNlcnZpY2VUeXBlRGV0YWlsc1wiIH0sXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgJGxvb2t1cDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmcm9tOiAncmlkZXR5cGVzJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxGaWVsZDogJ3JpZGVUeXBlJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWlnbkZpZWxkOiAnX2lkJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXM6ICdyaWRlVHlwZURldGFpbHMnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwaXBlbGluZTogW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRwcm9qZWN0OiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IDFcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgeyAkdW53aW5kOiBcIiRyaWRlVHlwZURldGFpbHNcIiB9LFxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICRsb29rdXA6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZnJvbTogJ3ZlaGljbGVjYXRlZ29yaWVzJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxGaWVsZDogJ3ZlaGljbGVDYXRlZ29yeScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVpZ25GaWVsZDogJ19pZCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzOiAndmVoaWNsZUNhdGVnb3J5RGV0YWlscycsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBpcGVsaW5lOiBbXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHByb2plY3Q6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogMVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB7ICR1bndpbmQ6IFwiJHZlaGljbGVDYXRlZ29yeURldGFpbHNcIiB9LFxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICRsb29rdXA6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZnJvbTogJ3N0YXRlcycsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsRmllbGQ6ICdzdGF0ZScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVpZ25GaWVsZDogJ19pZCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzOiAnc3RhdGVEZXRhaWxzJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGlwZWxpbmU6IFtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcHJvamVjdDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAxXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBdXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHsgJHVud2luZDogXCIkc3RhdGVEZXRhaWxzXCIgfSxcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAkbG9va3VwOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZyb206ICdkaXN0cmljdHMnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2NhbEZpZWxkOiAnZGlzdHJpY3QnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3JlaWduRmllbGQ6ICdfaWQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhczogJ2Rpc3RyaWN0RGV0YWlscycsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBpcGVsaW5lOiBbXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHByb2plY3Q6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogMVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB7ICR1bndpbmQ6IFwiJGRpc3RyaWN0RGV0YWlsc1wiIH0sXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgJGxvb2t1cDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmcm9tOiAndGFsdWtzJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxGaWVsZDogJ3RhbHVrJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWlnbkZpZWxkOiAnX2lkJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXM6ICd0YWx1a0RldGFpbHMnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwaXBlbGluZTogW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRwcm9qZWN0OiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IDFcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgeyAkdW53aW5kOiBcIiR0YWx1a0RldGFpbHNcIiB9LFxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIFwiJHByb2plY3RcIjoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlVHlwZTogMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmlkZVR5cGU6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZlaGljbGVDYXRlZ29yeTogMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGU6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3RyaWN0OiAxLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWx1azogMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYmFzZUZhcmU6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvb2tpbmdGYXJlOiAxLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwZXJNaW51dGVGYXJlOiAxLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYW5jZWxDaGFyZ2U6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdhaXRpbmdDaGFyZ2U6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFkbWluQ29tbWlzc2lvblR5cGU6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFkbWluQ29tbWlzc2lvblZhbHVlOiAxLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwZXJLTUNoYXJnZXM6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2VUeXBlRGV0YWlsczogMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmlkZVR5cGVEZXRhaWxzOiAxLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2ZWhpY2xlQ2F0ZWdvcnlEZXRhaWxzOiAxLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZURldGFpbHM6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3RyaWN0RGV0YWlsczogMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFsdWtEZXRhaWxzOiAxLFxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIF07XHJcblxyXG4gICAgICAgICAgICBjb25zdCBjb3VudGVyID0gYXdhaXQgRmFyZU1hbmFnZW1lbnRNb2RlbC5hZ2dyZWdhdGUoWy4uLiRhZ2dyZWdhdGUsIHsgJGNvdW50OiBcInRvdGFsXCIgfV0pO1xyXG4gICAgICAgICAgICByZXNwb25zZS5yZXN1bHQudG90YWwgPSBjb3VudGVyWzBdPy50b3RhbDtcclxuICAgICAgICAgICAgaWYgKGlzQWxsKSB7XHJcbiAgICAgICAgICAgICAgICByZXNwb25zZS5yZXN1bHQucGFnZSA9IDE7XHJcbiAgICAgICAgICAgICAgICByZXNwb25zZS5yZXN1bHQubGltaXQgPSByZXNwb25zZS5yZXN1bHQudG90YWw7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJlc3BvbnNlLnJlc3VsdC5kYXRhID0gYXdhaXQgRmFyZU1hbmFnZW1lbnRNb2RlbC5hZ2dyZWdhdGUoXHJcbiAgICAgICAgICAgICAgICBbXHJcbiAgICAgICAgICAgICAgICAgICAgLi4uJGFnZ3JlZ2F0ZSxcclxuICAgICAgICAgICAgICAgICAgICB7ICRsaW1pdDogcmVzcG9uc2UucmVzdWx0LmxpbWl0ICsgcmVzcG9uc2UucmVzdWx0LmxpbWl0ICogKHJlc3BvbnNlLnJlc3VsdC5wYWdlIC0gMSkgfSxcclxuICAgICAgICAgICAgICAgICAgICB7ICRza2lwOiByZXNwb25zZS5yZXN1bHQubGltaXQgKiAocmVzcG9uc2UucmVzdWx0LnBhZ2UgLSAxKSB9XHJcbiAgICAgICAgICAgICAgICBdKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5yZXN1bHQuZGF0YS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHJlc3BvbnNlLm1lc3NhZ2UgPSBcIkRhdGEgZmV0Y2hlZFwiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1c0NvZGUgPSAyMDA7XHJcbiAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1cyA9IHRydWU7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7XHJcblxyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGUpXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgc3RhdGljIGFzeW5jIHNhdmVGYXJlTWFuYWdlbWVuZ3QoZGF0YSkge1xyXG4gICAgICAgIGNvbnN0IF9pZCA9IGRhdGEuX2lkO1xyXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0geyBzdGF0dXNDb2RlOiA0MDAsIG1lc3NhZ2U6ICdFcnJvciEnLCBzdGF0dXM6IGZhbHNlIH07XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRwbERhdGEgPSBfaWQgPyBhd2FpdCBGYXJlTWFuYWdlbWVudE1vZGVsLmZpbmRCeUlkKF9pZCkgOiBuZXcgRmFyZU1hbmFnZW1lbnRNb2RlbCgpO1xyXG5cclxuICAgICAgICAgICAgdHBsRGF0YS5zZXJ2aWNlVHlwZSA9IGRhdGEuc2VydmljZVR5cGU7XHJcbiAgICAgICAgICAgIHRwbERhdGEucmlkZVR5cGUgPSBkYXRhLnJpZGVUeXBlO1xyXG4gICAgICAgICAgICB0cGxEYXRhLnZlaGljbGVDYXRlZ29yeSA9IGRhdGEudmVoaWNsZUNhdGVnb3J5O1xyXG4gICAgICAgICAgICB0cGxEYXRhLnN0YXRlID0gZGF0YS5zdGF0ZTtcclxuICAgICAgICAgICAgdHBsRGF0YS5kaXN0cmljdCA9IGRhdGEuZGlzdHJpY3Q7XHJcbiAgICAgICAgICAgIHRwbERhdGEudGFsdWsgPSBkYXRhLnRhbHVrO1xyXG4gICAgICAgICAgICB0cGxEYXRhLmJhc2VGYXJlID0gZGF0YS5iYXNlRmFyZTtcclxuICAgICAgICAgICAgdHBsRGF0YS5ib29raW5nRmFyZSA9IGRhdGEuYm9va2luZ0ZhcmU7XHJcbiAgICAgICAgICAgIHRwbERhdGEucGVyTWludXRlRmFyZSA9IGRhdGEucGVyTWludXRlRmFyZTtcclxuICAgICAgICAgICAgdHBsRGF0YS5jYW5jZWxDaGFyZ2UgPSBkYXRhLmNhbmNlbENoYXJnZTtcclxuICAgICAgICAgICAgdHBsRGF0YS53YWl0aW5nQ2hhcmdlID0gZGF0YS53YWl0aW5nQ2hhcmdlO1xyXG4gICAgICAgICAgICB0cGxEYXRhLmFkbWluQ29tbWlzc2lvblR5cGUgPSBkYXRhLmFkbWluQ29tbWlzc2lvblR5cGU7XHJcbiAgICAgICAgICAgIHRwbERhdGEuYWRtaW5Db21taXNzaW9uVmFsdWUgPSBkYXRhLmFkbWluQ29tbWlzc2lvblZhbHVlO1xyXG4gICAgICAgICAgICB0cGxEYXRhLnBlcktNQ2hhcmdlcyA9IGRhdGEucGVyS01DaGFyZ2VzO1xyXG5cclxuICAgICAgICAgICAgYXdhaXQgdHBsRGF0YS5zYXZlKCk7XHJcblxyXG4gICAgICAgICAgICByZXNwb25zZS5tZXNzYWdlID0gX2lkID8gXCJGYXJlIG1hbmFnZW1lbnQgaXMgVXBkYXRlZFwiIDogXCJBIG5ldyBmYXJlIG1hbmFnZW1lbnQgaXMgY3JlYXRlZFwiO1xyXG4gICAgICAgICAgICByZXNwb25zZS5zdGF0dXNDb2RlID0gMjAwO1xyXG4gICAgICAgICAgICByZXNwb25zZS5zdGF0dXMgPSB0cnVlO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xyXG5cclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlKVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHN0YXRpYyBhc3luYyBkZWxldGVGYXJlTWFuYWdlbWVuZ3QoX2lkLCBjb25kKSB7XHJcbiAgICAgICAgY29uZCA9ICFjb25kID8ge30gOiBjb25kO1xyXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0geyBzdGF0dXNDb2RlOiA0MDAsIG1lc3NhZ2U6ICdFcnJvciEnLCBzdGF0dXM6IGZhbHNlIH07XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGF3YWl0IEZhcmVNYW5hZ2VtZW50TW9kZWwudXBkYXRlT25lKHsgX2lkLCAuLi5jb25kIH0sIHsgaXNEZWxldGVkOiB0cnVlIH0pO1xyXG5cclxuICAgICAgICAgICAgcmVzcG9uc2UubWVzc2FnZSA9IFwiRGVsZXRlZCBzdWNjZXNzZnVsbHlcIjtcclxuICAgICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzQ29kZSA9IDIwMDtcclxuICAgICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzID0gdHJ1ZTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xyXG5cclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbiBub3QgZGVsZXRlLiBTb21ldGhpbmcgd2VudCB3cm9uZy5cIilcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBzdGF0aWMgYXN5bmMgZGVsZXRlRmFyZU1hbmFnZW1lbmd0UGVybWFuZW50KF9pZCwgY29uZCkge1xyXG4gICAgICAgIGNvbmQgPSAhY29uZCA/IHt9IDogY29uZDtcclxuICAgICAgICBjb25zdCByZXNwb25zZSA9IHsgc3RhdHVzQ29kZTogNDAwLCBtZXNzYWdlOiAnRXJyb3IhJywgc3RhdHVzOiBmYWxzZSB9O1xyXG5cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBhd2FpdCBGYXJlTWFuYWdlbWVudE1vZGVsLmRlbGV0ZU9uZSh7IF9pZCwgLi4uY29uZCB9KTtcclxuXHJcbiAgICAgICAgICAgIHJlc3BvbnNlLm1lc3NhZ2UgPSBcIkRlbGV0ZWQgc3VjY2Vzc2Z1bGx5XCI7XHJcbiAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1c0NvZGUgPSAyMDA7XHJcbiAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1cyA9IHRydWU7XHJcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZTtcclxuXHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW4gbm90IGRlbGV0ZS4gU29tZXRoaW5nIHdlbnQgd3JvbmcuXCIpXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59Il19