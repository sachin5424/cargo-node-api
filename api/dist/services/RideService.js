"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _helper = require("../utls/_helper");

var _config = _interopRequireDefault(require("../utls/config"));

var _rideTypeModel = _interopRequireDefault(require("../data-base/models/rideTypeModel"));

var _mongoose = _interopRequireDefault(require("mongoose"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Service {
  static async listRideType(query, params) {
    const isAll = params.isAll === 'ALL';
    const response = {
      statusCode: 400,
      message: 'Data not found!',
      result: {
        data: [],
        page: query.page * 1 > 0 ? query.page * 1 : 1,
        limit: query.limit * 1 > 0 ? query.limit * 1 : 20,
        total: 0
      },
      status: false
    };

    try {
      const search = {
        _id: query._id,
        isDeleted: false,
        $or: [{
          name: {
            $regex: '.*' + (query?.key || '') + '.*'
          }
        }, {
          key: {
            $regex: '.*' + (query?.key || '') + '.*'
          }
        }],
        serviceType: query.serviceType ? _mongoose.default.Types.ObjectId(query.serviceType) : ''
      };
      (0, _helper.clearSearch)(search);
      const $aggregate = [{
        $match: search
      }, {
        $sort: {
          serviceType: -1
        }
      }, {
        $lookup: {
          from: 'servicetypes',
          localField: 'serviceType',
          foreignField: '_id',
          as: 'serviceType',
          pipeline: [{
            "$project": {
              name: 1,
              key: 1
            }
          }]
        }
      }, {
        $lookup: {
          from: "vehiclecategories",
          localField: "allowedVehicleCategories",
          foreignField: "_id",
          as: "allowedVehicleCategoriesDetails",
          pipeline: [{
            $project: {
              name: 1,
              _id: 1
            }
          }]
        }
      }, {
        $unwind: "$serviceType"
      }, {
        "$project": {
          name: 1,
          key: 1,
          isActive: 1,
          serviceType: 1,
          allowedVehicleCategories: 1,
          allowedVehicleCategoriesDetails: 1,
          image: {
            url: {
              $concat: [_config.default.applicationFileUrl + 'ride/type/', "$photo"]
            },
            name: "$photo"
          }
        }
      }];
      const counter = await _rideTypeModel.default.aggregate([...$aggregate, {
        $count: "total"
      }]);
      response.result.total = counter[0]?.total;

      if (isAll) {
        response.result.page = 1;
        response.result.limit = response.result.total;
      }

      response.result.data = await _rideTypeModel.default.aggregate([...$aggregate, {
        $limit: response.result.limit + response.result.limit * (response.result.page - 1)
      }, {
        $skip: response.result.limit * (response.result.page - 1)
      }]);

      if (response.result.data.length) {
        response.message = "Data fetched";
      }

      response.statusCode = 200;
      response.status = true;
      return response;
    } catch (e) {
      throw new Error(e);
    }
  }

  static async saveRideType(data) {
    const _id = data._id;
    const response = {
      statusCode: 400,
      message: 'Error!',
      status: false
    };

    try {
      // const tplData = _id ? await RideTypeModel.findById(_id) : new RideTypeModel();
      const tplData = await _rideTypeModel.default.findById(_id);
      data._id || (tplData.serviceType = data.serviceType);
      tplData.name = data.name; // tplData.key = data.key;

      tplData.allowedVehicleCategories = data.allowedVehicleCategories;
      tplData.photo = await (0, _helper.uploadFile)(data.photo, _config.default.uploadPaths.ride.type, _rideTypeModel.default, 'photo', _id);
      tplData.isActive = data.isActive;
      await tplData.save();
      response.message = _id ? "Ride type is updated" : "A new ride type is created";
      response.statusCode = 200;
      response.status = true;
      return response;
    } catch (e) {
      throw new Error(e);
    }
  }

  static async deleteRideType(_id, cond) {
    (0, _helper.clearSearch)({
      cond
    });
    const response = {
      statusCode: 400,
      message: 'Error!',
      status: false
    };

    try {
      // await RideTypeModel.updateOne({ _id, ...cond }, { isDeleted: true });
      response.message = "Deleted successfully";
      response.statusCode = 200;
      response.status = true;
      return response;
    } catch (e) {
      throw new Error("Can not delete. Something went wrong.");
    }
  }

}

exports.default = Service;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2aWNlcy9SaWRlU2VydmljZS5qcyJdLCJuYW1lcyI6WyJTZXJ2aWNlIiwibGlzdFJpZGVUeXBlIiwicXVlcnkiLCJwYXJhbXMiLCJpc0FsbCIsInJlc3BvbnNlIiwic3RhdHVzQ29kZSIsIm1lc3NhZ2UiLCJyZXN1bHQiLCJkYXRhIiwicGFnZSIsImxpbWl0IiwidG90YWwiLCJzdGF0dXMiLCJzZWFyY2giLCJfaWQiLCJpc0RlbGV0ZWQiLCIkb3IiLCJuYW1lIiwiJHJlZ2V4Iiwia2V5Iiwic2VydmljZVR5cGUiLCJtb25nb29zZSIsIlR5cGVzIiwiT2JqZWN0SWQiLCIkYWdncmVnYXRlIiwiJG1hdGNoIiwiJHNvcnQiLCIkbG9va3VwIiwiZnJvbSIsImxvY2FsRmllbGQiLCJmb3JlaWduRmllbGQiLCJhcyIsInBpcGVsaW5lIiwiJHByb2plY3QiLCIkdW53aW5kIiwiaXNBY3RpdmUiLCJhbGxvd2VkVmVoaWNsZUNhdGVnb3JpZXMiLCJhbGxvd2VkVmVoaWNsZUNhdGVnb3JpZXNEZXRhaWxzIiwiaW1hZ2UiLCJ1cmwiLCIkY29uY2F0IiwiY29uZmlnIiwiYXBwbGljYXRpb25GaWxlVXJsIiwiY291bnRlciIsIlJpZGVUeXBlTW9kZWwiLCJhZ2dyZWdhdGUiLCIkY291bnQiLCIkbGltaXQiLCIkc2tpcCIsImxlbmd0aCIsImUiLCJFcnJvciIsInNhdmVSaWRlVHlwZSIsInRwbERhdGEiLCJmaW5kQnlJZCIsInBob3RvIiwidXBsb2FkUGF0aHMiLCJyaWRlIiwidHlwZSIsInNhdmUiLCJkZWxldGVSaWRlVHlwZSIsImNvbmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFFQTs7QUFDQTs7QUFDQTs7OztBQUVlLE1BQU1BLE9BQU4sQ0FBYztBQUVBLGVBQVpDLFlBQVksQ0FBQ0MsS0FBRCxFQUFRQyxNQUFSLEVBQWdCO0FBQ3JDLFVBQU1DLEtBQUssR0FBR0QsTUFBTSxDQUFDQyxLQUFQLEtBQWlCLEtBQS9CO0FBQ0EsVUFBTUMs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QzJCLFFBQXhCO0FBRUEsWUFBTWtCLE9BQU8sQ0FBQ00sSUFBUixFQUFOO0FBRUF2RCxNQUFBQSxRQUFRLENBQUNFLE9BQVQsR0FBbUJRLEdBQUcsR0FBRyxzQkFBSCxHQUE0Qiw0QkFBbEQ7QUFDQVYsTUFBQUEsUUFBUSxDQUFDQyxVQUFULEdBQXNCLEdBQXRCO0FBQ0FELE1BQUFBLFFBQVEsQ0FBQ1EsTUFBVCxHQUFrQixJQUFsQjtBQUVBLGFBQU9SLFFBQVA7QUFFSCxLQW5CRCxDQW1CRSxPQUFPOEMsQ0FBUCxFQUFVO0FBQ1IsWUFBTSxJQUFJQyxLQUFKLENBQVVELENBQVYsQ0FBTjtBQUNIO0FBQ0o7O0FBQzBCLGVBQWRVLGNBQWMsQ0FBQzlDLEdBQUQsRUFBTStDLElBQU4sRUFBWTtBQUNuQyw2QkFBWTtBQUFFQSxNQUFBQTtBQUFGLEtBQVo7QUFDQSxVQUFNekQsUUFBUSxHQUFHO0FBQUVDLE1BQUFBLFVBQVUsRUFBRSxHQUFkO0FBQW1CQyxNQUFBQSxPQUFPLEVBQUUsUUFBNUI7QUFBc0NNLE1BQUFBLE1BQU0sRUFBRTtBQUE5QyxLQUFqQjs7QUFFQSxRQUFJO0FBQ0E7QUFFQVIsTUFBQUEsUUFBUSxDQUFDRSxPQUFULEdBQW1CLHNCQUFuQjtBQUNBRixNQUFBQSxRQUFRLENBQUNDLFVBQVQsR0FBc0IsR0FBdEI7QUFDQUQsTUFBQUEsUUFBUSxDQUFDUSxNQUFULEdBQWtCLElBQWxCO0FBQ0EsYUFBT1IsUUFBUDtBQUVILEtBUkQsQ0FRRSxPQUFPOEMsQ0FBUCxFQUFVO0FBQ1IsWUFBTSxJQUFJQyxLQUFKLENBQVUsdUNBQVYsQ0FBTjtBQUNIO0FBQ0o7O0FBNUp3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNsZWFyU2VhcmNoIH0gZnJvbSBcIi4uL3V0bHMvX2hlbHBlclwiO1xyXG5pbXBvcnQgeyB1cGxvYWRGaWxlIH0gZnJvbSBcIi4uL3V0bHMvX2hlbHBlclwiO1xyXG5pbXBvcnQgY29uZmlnIGZyb20gXCIuLi91dGxzL2NvbmZpZ1wiO1xyXG5pbXBvcnQgUmlkZVR5cGVNb2RlbCBmcm9tIFwiLi4vZGF0YS1iYXNlL21vZGVscy9yaWRlVHlwZU1vZGVsXCI7XHJcbmltcG9ydCBtb25nb29zZSBmcm9tIFwibW9uZ29vc2VcIjtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNlcnZpY2Uge1xyXG5cclxuICAgIHN0YXRpYyBhc3luYyBsaXN0UmlkZVR5cGUocXVlcnksIHBhcmFtcykge1xyXG4gICAgICAgIGNvbnN0IGlzQWxsID0gcGFyYW1zLmlzQWxsID09PSAnQUxMJztcclxuICAgICAgICBjb25zdCByZXNwb25zZSA9IHtcclxuICAgICAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxyXG4gICAgICAgICAgICBtZXNzYWdlOiAnRGF0YSBub3QgZm91bmQhJyxcclxuICAgICAgICAgICAgcmVzdWx0OiB7XHJcbiAgICAgICAgICAgICAgICBkYXRhOiBbXSxcclxuICAgICAgICAgICAgICAgIHBhZ2U6IHF1ZXJ5LnBhZ2UgKiAxID4gMCA/IHF1ZXJ5LnBhZ2UgKiAxIDogMSxcclxuICAgICAgICAgICAgICAgIGxpbWl0OiBxdWVyeS5saW1pdCAqIDEgPiAwID8gcXVlcnkubGltaXQgKiAxIDogMjAsXHJcbiAgICAgICAgICAgICAgICB0b3RhbDogMCxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgc3RhdHVzOiBmYWxzZVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNlYXJjaCA9IHtcclxuICAgICAgICAgICAgICAgIF9pZDogcXVlcnkuX2lkLFxyXG4gICAgICAgICAgICAgICAgaXNEZWxldGVkOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICRvcjogW1xyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogeyAkcmVnZXg6ICcuKicgKyAocXVlcnk/LmtleSB8fCAnJykgKyAnLionIH1cclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAga2V5OiB7ICRyZWdleDogJy4qJyArIChxdWVyeT8ua2V5IHx8ICcnKSArICcuKicgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBdLFxyXG4gICAgICAgICAgICAgICAgc2VydmljZVR5cGU6IHF1ZXJ5LnNlcnZpY2VUeXBlID8gbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQocXVlcnkuc2VydmljZVR5cGUpIDogJydcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIGNsZWFyU2VhcmNoKHNlYXJjaCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCAkYWdncmVnYXRlID0gW1xyXG4gICAgICAgICAgICAgICAgeyAkbWF0Y2g6IHNlYXJjaCB9LFxyXG4gICAgICAgICAgICAgICAgeyAkc29ydDogeyBzZXJ2aWNlVHlwZTogLTEgfSB9LFxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICRsb29rdXA6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZnJvbTogJ3NlcnZpY2V0eXBlcycsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsRmllbGQ6ICdzZXJ2aWNlVHlwZScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVpZ25GaWVsZDogJ19pZCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzOiAnc2VydmljZVR5cGUnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwaXBlbGluZTogW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiJHByb2plY3RcIjoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAxLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXk6IDFcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF1cclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAkbG9va3VwOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZyb206IFwidmVoaWNsZWNhdGVnb3JpZXNcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxGaWVsZDogXCJhbGxvd2VkVmVoaWNsZUNhdGVnb3JpZXNcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWlnbkZpZWxkOiBcIl9pZFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhczogXCJhbGxvd2VkVmVoaWNsZUNhdGVnb3JpZXNEZXRhaWxzXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBpcGVsaW5lOiBbXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHByb2plY3Q6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2lkOiAxLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICR1bndpbmQ6IFwiJHNlcnZpY2VUeXBlXCJcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgXCIkcHJvamVjdFwiOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleTogMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaXNBY3RpdmU6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2VUeXBlOiAxLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhbGxvd2VkVmVoaWNsZUNhdGVnb3JpZXM6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsbG93ZWRWZWhpY2xlQ2F0ZWdvcmllc0RldGFpbHM6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHsgJGNvbmNhdDogW2NvbmZpZy5hcHBsaWNhdGlvbkZpbGVVcmwgKyAncmlkZS90eXBlLycsIFwiJHBob3RvXCJdIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBcIiRwaG90b1wiXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBdO1xyXG5cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGNvdW50ZXIgPSBhd2FpdCBSaWRlVHlwZU1vZGVsLmFnZ3JlZ2F0ZShbLi4uJGFnZ3JlZ2F0ZSwgeyAkY291bnQ6IFwidG90YWxcIiB9XSk7XHJcbiAgICAgICAgICAgIHJlc3BvbnNlLnJlc3VsdC50b3RhbCA9IGNvdW50ZXJbMF0/LnRvdGFsO1xyXG4gICAgICAgICAgICBpZiAoaXNBbGwpIHtcclxuICAgICAgICAgICAgICAgIHJlc3BvbnNlLnJlc3VsdC5wYWdlID0gMTtcclxuICAgICAgICAgICAgICAgIHJlc3BvbnNlLnJlc3VsdC5saW1pdCA9IHJlc3BvbnNlLnJlc3VsdC50b3RhbDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmVzcG9uc2UucmVzdWx0LmRhdGEgPSBhd2FpdCBSaWRlVHlwZU1vZGVsLmFnZ3JlZ2F0ZShcclxuICAgICAgICAgICAgICAgIFtcclxuICAgICAgICAgICAgICAgICAgICAuLi4kYWdncmVnYXRlLFxyXG4gICAgICAgICAgICAgICAgICAgIHsgJGxpbWl0OiByZXNwb25zZS5yZXN1bHQubGltaXQgKyByZXNwb25zZS5yZXN1bHQubGltaXQgKiAocmVzcG9uc2UucmVzdWx0LnBhZ2UgLSAxKSB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHsgJHNraXA6IHJlc3BvbnNlLnJlc3VsdC5saW1pdCAqIChyZXNwb25zZS5yZXN1bHQucGFnZSAtIDEpIH1cclxuICAgICAgICAgICAgICAgIF0pO1xyXG5cclxuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnJlc3VsdC5kYXRhLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgcmVzcG9uc2UubWVzc2FnZSA9IFwiRGF0YSBmZXRjaGVkXCI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzQ29kZSA9IDIwMDtcclxuICAgICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZTtcclxuXHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZSlcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBzdGF0aWMgYXN5bmMgc2F2ZVJpZGVUeXBlKGRhdGEpIHtcclxuICAgICAgICBjb25zdCBfaWQgPSBkYXRhLl9pZDtcclxuICAgICAgICBjb25zdCByZXNwb25zZSA9IHsgc3RhdHVzQ29kZTogNDAwLCBtZXNzYWdlOiAnRXJyb3IhJywgc3RhdHVzOiBmYWxzZSB9O1xyXG5cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAvLyBjb25zdCB0cGxEYXRhID0gX2lkID8gYXdhaXQgUmlkZVR5cGVNb2RlbC5maW5kQnlJZChfaWQpIDogbmV3IFJpZGVUeXBlTW9kZWwoKTtcclxuICAgICAgICAgICAgY29uc3QgdHBsRGF0YSA9IGF3YWl0IFJpZGVUeXBlTW9kZWwuZmluZEJ5SWQoX2lkKTtcclxuXHJcbiAgICAgICAgICAgIChkYXRhLl9pZCB8fCAodHBsRGF0YS5zZXJ2aWNlVHlwZSA9IGRhdGEuc2VydmljZVR5cGUpKTtcclxuICAgICAgICAgICAgdHBsRGF0YS5uYW1lID0gZGF0YS5uYW1lO1xyXG4gICAgICAgICAgICAvLyB0cGxEYXRhLmtleSA9IGRhdGEua2V5O1xyXG4gICAgICAgICAgICB0cGxEYXRhLmFsbG93ZWRWZWhpY2xlQ2F0ZWdvcmllcyA9IGRhdGEuYWxsb3dlZFZlaGljbGVDYXRlZ29yaWVzO1xyXG4gICAgICAgICAgICB0cGxEYXRhLnBob3RvID0gYXdhaXQgdXBsb2FkRmlsZShkYXRhLnBob3RvLCBjb25maWcudXBsb2FkUGF0aHMucmlkZS50eXBlLCBSaWRlVHlwZU1vZGVsLCAncGhvdG8nLCBfaWQpO1xyXG4gICAgICAgICAgICB0cGxEYXRhLmlzQWN0aXZlID0gZGF0YS5pc0FjdGl2ZTtcclxuXHJcbiAgICAgICAgICAgIGF3YWl0IHRwbERhdGEuc2F2ZSgpO1xyXG5cclxuICAgICAgICAgICAgcmVzcG9uc2UubWVzc2FnZSA9IF9pZCA/IFwiUmlkZSB0eXBlIGlzIHVwZGF0ZWRcIiA6IFwiQSBuZXcgcmlkZSB0eXBlIGlzIGNyZWF0ZWRcIjtcclxuICAgICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzQ29kZSA9IDIwMDtcclxuICAgICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZTtcclxuXHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZSlcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBzdGF0aWMgYXN5bmMgZGVsZXRlUmlkZVR5cGUoX2lkLCBjb25kKSB7XHJcbiAgICAgICAgY2xlYXJTZWFyY2goeyBjb25kIH0pO1xyXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0geyBzdGF0dXNDb2RlOiA0MDAsIG1lc3NhZ2U6ICdFcnJvciEnLCBzdGF0dXM6IGZhbHNlIH07XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIC8vIGF3YWl0IFJpZGVUeXBlTW9kZWwudXBkYXRlT25lKHsgX2lkLCAuLi5jb25kIH0sIHsgaXNEZWxldGVkOiB0cnVlIH0pO1xyXG5cclxuICAgICAgICAgICAgcmVzcG9uc2UubWVzc2FnZSA9IFwiRGVsZXRlZCBzdWNjZXNzZnVsbHlcIjtcclxuICAgICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzQ29kZSA9IDIwMDtcclxuICAgICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzID0gdHJ1ZTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xyXG5cclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbiBub3QgZGVsZXRlLiBTb21ldGhpbmcgd2VudCB3cm9uZy5cIilcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0iXX0=