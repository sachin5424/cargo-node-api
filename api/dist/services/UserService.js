"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _dataBase = require("../data-base");

var _helper = require("../utls/_helper");

var _config = _interopRequireDefault(require("../utls/config"));

var _bcryptjs = _interopRequireDefault(require("bcryptjs"));

var _jsonwebtoken = _interopRequireDefault(require("jsonwebtoken"));

var _adminModules = _interopRequireDefault(require("../data-base/models/adminModules"));

var _modue = _interopRequireDefault(require("../data-base/models/modue"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class Service {
  static async userLogin(data) {
    const response = {
      statusCode: 400,
      message: 'Error!',
      status: false
    };
    const email = data.email;
    const password = data.password;

    try {
      const user = await _dataBase.UserModel.findOne({
        email: email,
        isDeleted: false
      });
      let isPasswordMatched = await _bcryptjs.default.compare(password, user.password);

      if (!isPasswordMatched) {
        throw new Error("Invalid Credentials");
      } else {
        const JWT_EXP_DUR = _config.default.jwt.expDuration;

        const accessToken = _jsonwebtoken.default.sign({
          sub: user._id.toString(),
          exp: Math.floor(Date.now() / 1000) + JWT_EXP_DUR * 60
        }, _config.default.jwt.secretKey);

        if (!user.emailVerified) {
          response.statusCode = 401;
          response.message = "Email is not verified. Please verify from the link sent to your email!!";
        } else if (!user.isActive) {
          response.statusCode = 401;
          response.message = "Your acount is blocked. Please contact admin";
        } else {
          response.statusCode = 200;
          response.status = true;
          response.message = "Loggedin successfully";
          let modules = [];

          if (user.type !== 'superAdmin') {
            modules = await _adminModules.default.findOne({
              typeKey: user.type
            }).select({
              grantedModules: 1
            });
            modules = modules.grantedModules;
          } else {
            modules = await _modue.default.find();
            modules = modules.map(v => v.key);
          }

          response.data = {
            accessToken,
            modules,
            userType: user.type
          };
        }
      }
    } catch (e) {
      throw new Error(e.message);
    }

    return response;
  }

  static async listUser(query, params) {
    const isAll = params.isAll === 'ALL';
    const response = {
      statusCode: 400,
      message: 'Data not found!',
      result: {
        data: [],
        page: query.page * 1 > 0 ? query.page * 1 : 1,
        limit: query.limit * 1 > 0 ? query.limit * 1 : 20,
        total: 0
      },
      status: false
    };

    try {
      const search = _objectSpread({
        _id: query._id,
        isDeleted: false,
        type: {
          $ne: 'superAdmin'
        },
        $or: [{
          firstName: {
            $regex: '.*' + (query?.key || '') + '.*'
          }
        }, {
          lastName: {
            $regex: '.*' + (query?.key || '') + '.*'
          }
        }]
      }, (0, _helper.getAdminFilter)());

      if (global.cuser.type === 'stateAdmin') {
        search.type = {
          $in: ['districtAdmin', 'talukAdmin']
        };
      } else if (global.cuser.type === 'districtAdmin') {
        search.type = {
          $in: ['talukAdmin']
        };
      }

      (0, _helper.clearSearch)(search); // const driverFilter ={isDeleted: false, ...getAdminFilter()};
      // clearSearch(driverFilter);

      const $aggregate = [{
        $match: search
      }, {
        $sort: {
          _id: -1
        }
      }, {
        "$project": {
          firstName: 1,
          lastName: 1,
          phoneNo: 1,
          email: 1,
          emailVerified: 1,
          dob: 1,
          type: 1,
          address: 1,
          state: 1,
          district: 1,
          taluk: 1,
          zipcode: 1,
          adharNo: 1,
          panNo: 1,
          isActive: 1,
          image: {
            url: {
              $concat: [_config.default.applicationFileUrl + 'user/photo/', "$photo"]
            },
            name: "$photo"
          },
          adharCardImage: {
            url: {
              $concat: [_config.default.applicationFileUrl + 'user/document/', "$adharCardPhoto"]
            },
            name: "$photo"
          },
          panCardImage: {
            url: {
              $concat: [_config.default.applicationFileUrl + 'user/document/', "$panCardPhoto"]
            },
            name: "$photo"
          }
        }
      }];
      const counter = await _dataBase.UserModel.aggregate([...$aggregate, {
        $count: "total"
      }]);
      response.result.total = counter[0]?.total;

      if (isAll) {
        response.result.page = 1;
        response.result.limit = response.result.total;
      }

      response.result.data = await _dataBase.UserModel.aggregate([...$aggregate, {
        $limit: response.result.limit + response.result.limit * (response.result.page - 1)
      }, {
        $skip: response.result.limit * (response.result.page - 1)
      }]);

      if (response.result.data.length) {
        response.message = "Data fetched";
      }

      response.statusCode = 200;
      response.status = true;
      return response;
    } catch (e) {
      throw new Error(e);
    }
  }

  static async saveUser(data) {
    const _id = data._id;
    const response = {
      statusCode: 400,
      message: 'Error!',
      status: false
    };

    try {
      const tplData = _id ? await _dataBase.UserModel.findById(_id) : new _dataBase.UserModel();
      tplData.type = data.type;
      tplData.firstName = data.firstName;
      tplData.lastName = data.lastName;
      tplData.phoneNo = data.phoneNo;
      tplData.email = data.email;
      tplData.emailVerified = true;
      !data.password || (tplData.password = data.password);
      tplData.dob = data.dob;
      tplData.photo = await (0, _helper.uploadFile)(data.photo, _config.default.uploadPaths.user.photo, _dataBase.UserModel, 'photo', _id);
      tplData.adharNo = data.adharNo;
      tplData.adharCardPhoto = await (0, _helper.uploadFile)(data.adharCardPhoto, _config.default.uploadPaths.user.document, _dataBase.UserModel, 'adharCardPhoto', _id);
      tplData.panNo = data.panNo;
      tplData.panCardPhoto = await (0, _helper.uploadFile)(data.panCardPhoto, _config.default.uploadPaths.user.document, _dataBase.UserModel, 'panCardPhoto', _id);
      tplData.address = data.address;
      tplData.state = data.state;
      tplData.district = data.district;
      tplData.taluk = data.taluk;
      tplData.zipcode = data.zipcode;
      tplData.isActive = data.isActive;
      await tplData.save();
      response.message = _id ? "Admin is Updated" : "A new admin is created";
      response.statusCode = 200;
      response.status = true;
      return response;
    } catch (e) {
      throw new Error(e);
    }
  }

  static async deleteUser(_id, cond) {
    (0, _helper.clearSearch)({
      cond
    });
    const response = {
      statusCode: 400,
      message: 'Error!',
      status: false
    };

    try {
      await _dataBase.UserModel.updateOne(_objectSpread({
        _id
      }, cond), {
        isDeleted: true
      });
      response.message = "Deleted successfully";
      response.statusCode = 200;
      response.status = true;
      return response;
    } catch (e) {
      throw new Error("Can not delete. Something went wrong.");
    }
  }

}

exports.default = Service;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2aWNlcy9Vc2VyU2VydmljZS5qcyJdLCJuYW1lcyI6WyJTZXJ2aWNlIiwidXNlckxvZ2luIiwiZGF0YSIsInJlc3BvbnNlIiwic3RhdHVzQ29kZSIsIm1lc3NhZ2UiLCJzdGF0dXMiLCJlbWFpbCIsInBhc3N3b3JkIiwidXNlciIsIlVzZXJNb2RlbCIsImZpbmRPbmUiLCJpc0RlbGV0ZWQiLCJpc1Bhc3N3b3JkTWF0Y2hlZCIsImJjcnlwdCIsImNvbXBhcmUiLCJFcnJvciIsIkpXVF9FWFBfRFVSIiwiY29uZmlnIiwiand0IiwiZXhwRHVyYXRpb24iLCJhY2Nlc3NUb2tlbiIsInNpZ24iLCJzdWIiLCJfaWQiLCJ0b1N0cmluZyIsImV4cCIsIk1hdGgiLCJmbG9vciIsIkRhdGUiLCJub3ciLCJzZWNyZXRLZXkiLCJlbWFpbFZlcmlmaWVkIiwiaXNBY3RpdmUiLCJtb2R1bGVzIiwidHlwZSIsIkFkbWluTW9kdWxlc01vZGVsIiwidHlwZUtleSIsInNlbGVjdCIsImdyYW50ZWRNb2R1bGVzIiwiTW9kdWxlTW9kZWwiLCJmaW5kIiwibWFwIiwidiIsImtleSIsInVzZXJUeXBlIiwiZSIsImxpc3RVc2VyIiwicXVlcnkiLCJwYXJhbXMiLCJpc0FsbCIsInJlc3VsdCIsInBhZ2UiLCJsaW1pdCIsInRvdGFsIiwic2VhcmNoIiwiJG5lIiwiJG9yIiwiZmlyc3ROYW1lIiwiJHJlZ2V4IiwibGFzdE5hbWUiLCJnbG9iYWwiLCJjdXNlciIsIiRpbiIsIiRhZ2dyZWdhdGUiLCIkbWF0Y2giLCIkc29ydCIsInBob25lTm8iLCJkb2IiLCJhZGRyZXNzIiwic3RhdGUiLCJkaXN0cmljdCIsInRhbHVrIiwiemlwY29kZSIsImFkaGFyTm8iLCJwYW5ObyIsImltYWdlIiwidXJsIiwiJGNvbmNhdCIsImFwcGxpY2F0aW9uRmlsZVVybCIsIm5hbWUiLCJhZGhhckNhcmRJbWFnZSIsInBhbkNhcmRJbWFnZSIsImNvdW50ZXIiLCJhZ2dyZWdhdGUiLCIkY291bnQiLCIkbGltaXQiLCIkc2tpcCIsImxlbmd0aCIsInNhdmVVc2VyIiwidHBsRGF0YSIsImZpbmRCeUlkIiwicGhvdG8iLCJ1cGxvYWRQYXRocyIsImFkaGFyQ2FyZFBob3RvIiwiZG9jdW1lbnQiLCJwYW5DYXJkUGhvdG8iLCJzYXZlIiwiZGVsZXRlVXNlciIsImNvbmQiLCJ1cGRhdGVPbmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7OztBQUVlLE1BQU1BLE9BQU4sQ0FBYztBQUVILGVBQVRDLFNBQVMsQ0FBQ0MsSUFBRCxFQUFPO0FBQ3pCLFVBQU1DLFFBQVEsR0FBRztBQUFFQyxNQUFBQSxVQUFVLEVBQUUsR0FBZDtBQUFtQkMsTUFBQUEsT0FBTyxFQUFFLFFBQTVCO0FBQXNDQyxNQUFBQSxNQUFNLEVBQUU7QUFBOUMsS0FBakI7QUFDQSxVQUFNQyxLQUFLLEdBQUdMLElBQUksQ0FBQ0ssS0FBbkI7QUFDQSxVQUFNQyxRQUFRLEdBQUdOLElBQUksQ0FBQ00sUUFBdEI7O0FBRUEsUUFBSTtBQUNBLFlBQU1DLElBQUksR0FBRyxNQUFNQyxvQkFBVUMsT0FBVixDQUFrQjtBQUFFSixRQUFBQSxLQUFLLEVBQUVBLEtBQVQ7QUFBZ0JLLFFBQUFBLFNBQVMsRUFBRTtBQUEzQixPQUFsQixDQUFuQjtBQUNBLFVBQUlDLGlCQUFpQixHQUFHLE1BQU1DLGtCQUFPQyxPQUFQLENBQWVQLFFBQWYsRUFBeUJDLElBQUksQ0FBQ0QsUUFBOUIsQ0FBOUI7O0FBQ0EsVUFBSSxDQUFDSyxpQkFBTCxFQUF3QjtBQUNwQixjQUFNLElBQUlHLEtBQUosQ0FBVSxxQkFBVixDQUFOO0FBQ0gsT0FGRCxNQUVPO0FBQ0gsY0FBTUMsV0FBVyxHQUFHQyxnQkFBT0MsR0FBUCxDQUFXQyxXQUEvQjs7QUFDQSxjQUFNQyxXQUFXLEdBQUdGLHNCQUFJRyxJQUFKLENBQVM7QUFBRUMsVUFBQUEsR0FBRyxFQUFFZCxJQUFJLENBQUNlLEdBQUwsQ0FBU0Ms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QXdCLHdCQUE5QztBQUNBckIsTUFBQUEsUUFBUSxDQUFDQyxVQUFULEdBQXNCLEdBQXRCO0FBQ0FELE1BQUFBLFFBQVEsQ0FBQ0csTUFBVCxHQUFrQixJQUFsQjtBQUVBLGFBQU9ILFFBQVA7QUFFSCxLQWxDRCxDQWtDRSxPQUFPMkMsQ0FBUCxFQUFVO0FBQ1IsWUFBTSxJQUFJOUIsS0FBSixDQUFVOEIsQ0FBVixDQUFOO0FBQ0g7QUFDSjs7QUFDc0IsZUFBVm9ELFVBQVUsQ0FBQzFFLEdBQUQsRUFBTTJFLElBQU4sRUFBWTtBQUMvQiw2QkFBWTtBQUFFQSxNQUFBQTtBQUFGLEtBQVo7QUFDQSxVQUFNaEcsUUFBUSxHQUFHO0FBQUVDLE1BQUFBLFVBQVUsRUFBRSxHQUFkO0FBQW1CQyxNQUFBQSxPQUFPLEVBQUUsUUFBNUI7QUFBc0NDLE1BQUFBLE1BQU0sRUFBRTtBQUE5QyxLQUFqQjs7QUFFQSxRQUFJO0FBQ0EsWUFBTUksb0JBQVUwRixTQUFWO0FBQXNCNUUsUUFBQUE7QUFBdEIsU0FBOEIyRSxJQUE5QixHQUFzQztBQUFFdkYsUUFBQUEsU0FBUyxFQUFFO0FBQWIsT0FBdEMsQ0FBTjtBQUVBVCxNQUFBQSxRQUFRLENBQUNFLE9BQVQsR0FBbUIsc0JBQW5CO0FBQ0FGLE1BQUFBLFFBQVEsQ0FBQ0MsVUFBVCxHQUFzQixHQUF0QjtBQUNBRCxNQUFBQSxRQUFRLENBQUNHLE1BQVQsR0FBa0IsSUFBbEI7QUFDQSxhQUFPSCxRQUFQO0FBRUgsS0FSRCxDQVFFLE9BQU8yQyxDQUFQLEVBQVU7QUFDUixZQUFNLElBQUk5QixLQUFKLENBQVUsdUNBQVYsQ0FBTjtBQUNIO0FBQ0o7O0FBOU13QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFVzZXJNb2RlbCB9IGZyb20gXCIuLi9kYXRhLWJhc2VcIjtcclxuaW1wb3J0IHsgY2xlYXJTZWFyY2gsIHVwbG9hZEZpbGUsIGdldEFkbWluRmlsdGVyIH0gZnJvbSBcIi4uL3V0bHMvX2hlbHBlclwiO1xyXG5pbXBvcnQgY29uZmlnIGZyb20gXCIuLi91dGxzL2NvbmZpZ1wiO1xyXG5pbXBvcnQgYmNyeXB0IGZyb20gXCJiY3J5cHRqc1wiO1xyXG5pbXBvcnQgand0IGZyb20gXCJqc29ud2VidG9rZW5cIjtcclxuaW1wb3J0IEFkbWluTW9kdWxlc01vZGVsIGZyb20gXCIuLi9kYXRhLWJhc2UvbW9kZWxzL2FkbWluTW9kdWxlc1wiO1xyXG5pbXBvcnQgTW9kdWxlTW9kZWwgZnJvbSBcIi4uL2RhdGEtYmFzZS9tb2RlbHMvbW9kdWVcIjtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNlcnZpY2Uge1xyXG5cclxuICAgIHN0YXRpYyBhc3luYyB1c2VyTG9naW4oZGF0YSkge1xyXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0geyBzdGF0dXNDb2RlOiA0MDAsIG1lc3NhZ2U6ICdFcnJvciEnLCBzdGF0dXM6IGZhbHNlIH07XHJcbiAgICAgICAgY29uc3QgZW1haWwgPSBkYXRhLmVtYWlsO1xyXG4gICAgICAgIGNvbnN0IHBhc3N3b3JkID0gZGF0YS5wYXNzd29yZDtcclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXJNb2RlbC5maW5kT25lKHsgZW1haWw6IGVtYWlsLCBpc0RlbGV0ZWQ6IGZhbHNlIH0pO1xyXG4gICAgICAgICAgICBsZXQgaXNQYXNzd29yZE1hdGNoZWQgPSBhd2FpdCBiY3J5cHQuY29tcGFyZShwYXNzd29yZCwgdXNlci5wYXNzd29yZCk7XHJcbiAgICAgICAgICAgIGlmICghaXNQYXNzd29yZE1hdGNoZWQpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgQ3JlZGVudGlhbHNcIik7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBKV1RfRVhQX0RVUiA9IGNvbmZpZy5qd3QuZXhwRHVyYXRpb247XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhY2Nlc3NUb2tlbiA9IGp3dC5zaWduKHsgc3ViOiB1c2VyLl9pZC50b1N0cmluZygpLCBleHA6IE1hdGguZmxvb3IoRGF0ZS5ub3coKSAvIDEwMDApICsgKChKV1RfRVhQX0RVUikgKiA2MCksIH0sIGNvbmZpZy5qd3Quc2VjcmV0S2V5KTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoIXVzZXIuZW1haWxWZXJpZmllZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1c0NvZGUgPSA0MDE7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UubWVzc2FnZSA9IFwiRW1haWwgaXMgbm90IHZlcmlmaWVkLiBQbGVhc2UgdmVyaWZ5IGZyb20gdGhlIGxpbmsgc2VudCB0byB5b3VyIGVtYWlsISFcIjtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXVzZXIuaXNBY3RpdmUpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5zdGF0dXNDb2RlID0gNDAxO1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLm1lc3NhZ2UgPSBcIllvdXIgYWNvdW50IGlzIGJsb2NrZWQuIFBsZWFzZSBjb250YWN0IGFkbWluXCI7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1c0NvZGUgPSAyMDA7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5tZXNzYWdlID0gXCJMb2dnZWRpbiBzdWNjZXNzZnVsbHlcIjtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IG1vZHVsZXMgPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICBpZih1c2VyLnR5cGUgIT09ICdzdXBlckFkbWluJyl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZXMgPSBhd2FpdCBBZG1pbk1vZHVsZXNNb2RlbC5maW5kT25lKHt0eXBlS2V5OiB1c2VyLnR5cGV9KS5zZWxlY3Qoe2dyYW50ZWRNb2R1bGVzOiAxfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZXMgPSBtb2R1bGVzLmdyYW50ZWRNb2R1bGVzO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlcyA9IGF3YWl0IE1vZHVsZU1vZGVsLmZpbmQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlcyA9IG1vZHVsZXMubWFwKHY9PnYua2V5KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEgPSB7IGFjY2Vzc1Rva2VuLCBtb2R1bGVzLCB1c2VyVHlwZTogdXNlci50eXBlIH07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlLm1lc3NhZ2UpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBzdGF0aWMgYXN5bmMgbGlzdFVzZXIocXVlcnksIHBhcmFtcykge1xyXG4gICAgICAgIGNvbnN0IGlzQWxsID0gcGFyYW1zLmlzQWxsID09PSAnQUxMJztcclxuICAgICAgICBjb25zdCByZXNwb25zZSA9IHtcclxuICAgICAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxyXG4gICAgICAgICAgICBtZXNzYWdlOiAnRGF0YSBub3QgZm91bmQhJyxcclxuICAgICAgICAgICAgcmVzdWx0OiB7XHJcbiAgICAgICAgICAgICAgICBkYXRhOiBbXSxcclxuICAgICAgICAgICAgICAgIHBhZ2U6IHF1ZXJ5LnBhZ2UgKiAxID4gMCA/IHF1ZXJ5LnBhZ2UgKiAxIDogMSxcclxuICAgICAgICAgICAgICAgIGxpbWl0OiBxdWVyeS5saW1pdCAqIDEgPiAwID8gcXVlcnkubGltaXQgKiAxIDogMjAsXHJcbiAgICAgICAgICAgICAgICB0b3RhbDogMCxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgc3RhdHVzOiBmYWxzZVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNlYXJjaCA9IHtcclxuICAgICAgICAgICAgICAgIF9pZDogcXVlcnkuX2lkLFxyXG4gICAgICAgICAgICAgICAgaXNEZWxldGVkOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIHR5cGU6IHsgJG5lOiAnc3VwZXJBZG1pbicgfSxcclxuICAgICAgICAgICAgICAgICRvcjogW1xyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB7ICRyZWdleDogJy4qJyArIChxdWVyeT8ua2V5IHx8ICcnKSArICcuKicgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsYXN0TmFtZTogeyAkcmVnZXg6ICcuKicgKyAocXVlcnk/LmtleSB8fCAnJykgKyAnLionIH1cclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgXSxcclxuXHJcbiAgICAgICAgICAgICAgICAuLi5nZXRBZG1pbkZpbHRlcigpXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGlmKGdsb2JhbC5jdXNlci50eXBlID09PSAnc3RhdGVBZG1pbicpe1xyXG4gICAgICAgICAgICAgICAgc2VhcmNoLnR5cGUgPSB7JGluOiBbJ2Rpc3RyaWN0QWRtaW4nLCAndGFsdWtBZG1pbiddfTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmKGdsb2JhbC5jdXNlci50eXBlID09PSAnZGlzdHJpY3RBZG1pbicpe1xyXG4gICAgICAgICAgICAgICAgc2VhcmNoLnR5cGUgPSB7JGluOiBbJ3RhbHVrQWRtaW4nXX07XHJcbiAgICAgICAgICAgIH0gXHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjbGVhclNlYXJjaChzZWFyY2gpO1xyXG4gICAgICAgICAgICAvLyBjb25zdCBkcml2ZXJGaWx0ZXIgPXtpc0RlbGV0ZWQ6IGZhbHNlLCAuLi5nZXRBZG1pbkZpbHRlcigpfTtcclxuICAgICAgICAgICAgLy8gY2xlYXJTZWFyY2goZHJpdmVyRmlsdGVyKTtcclxuICAgICAgICAgICAgY29uc3QgJGFnZ3JlZ2F0ZSA9IFtcclxuICAgICAgICAgICAgICAgIHsgJG1hdGNoOiBzZWFyY2ggfSxcclxuICAgICAgICAgICAgICAgIHsgJHNvcnQ6IHsgX2lkOiAtMSB9IH0sXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgXCIkcHJvamVjdFwiOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBob25lTm86IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVtYWlsOiAxLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbWFpbFZlcmlmaWVkOiAxLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb2I6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3M6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlOiAxLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXN0cmljdDogMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFsdWs6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHppcGNvZGU6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFkaGFyTm86IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhbk5vOiAxLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpc0FjdGl2ZTogMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2U6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogeyAkY29uY2F0OiBbY29uZmlnLmFwcGxpY2F0aW9uRmlsZVVybCArICd1c2VyL3Bob3RvLycsIFwiJHBob3RvXCJdIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBcIiRwaG90b1wiXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFkaGFyQ2FyZEltYWdlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHsgJGNvbmNhdDogW2NvbmZpZy5hcHBsaWNhdGlvbkZpbGVVcmwgKyAndXNlci9kb2N1bWVudC8nLCBcIiRhZGhhckNhcmRQaG90b1wiXSB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogXCIkcGhvdG9cIlxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYW5DYXJkSW1hZ2U6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogeyAkY29uY2F0OiBbY29uZmlnLmFwcGxpY2F0aW9uRmlsZVVybCArICd1c2VyL2RvY3VtZW50LycsIFwiJHBhbkNhcmRQaG90b1wiXSB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogXCIkcGhvdG9cIlxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgXTtcclxuXHJcblxyXG4gICAgICAgICAgICBjb25zdCBjb3VudGVyID0gYXdhaXQgVXNlck1vZGVsLmFnZ3JlZ2F0ZShbLi4uJGFnZ3JlZ2F0ZSwgeyAkY291bnQ6IFwidG90YWxcIiB9XSk7XHJcbiAgICAgICAgICAgIHJlc3BvbnNlLnJlc3VsdC50b3RhbCA9IGNvdW50ZXJbMF0/LnRvdGFsO1xyXG4gICAgICAgICAgICBpZihpc0FsbCl7XHJcbiAgICAgICAgICAgICAgICByZXNwb25zZS5yZXN1bHQucGFnZSA9IDE7XHJcbiAgICAgICAgICAgICAgICByZXNwb25zZS5yZXN1bHQubGltaXQgPSByZXNwb25zZS5yZXN1bHQudG90YWw7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJlc3BvbnNlLnJlc3VsdC5kYXRhID0gYXdhaXQgVXNlck1vZGVsLmFnZ3JlZ2F0ZShcclxuICAgICAgICAgICAgICAgIFtcclxuICAgICAgICAgICAgICAgICAgICAuLi4kYWdncmVnYXRlLFxyXG4gICAgICAgICAgICAgICAgICAgIHsgJGxpbWl0OiByZXNwb25zZS5yZXN1bHQubGltaXQgKyByZXNwb25zZS5yZXN1bHQubGltaXQgKiAocmVzcG9uc2UucmVzdWx0LnBhZ2UgLSAxKSB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHsgJHNraXA6IHJlc3BvbnNlLnJlc3VsdC5saW1pdCAqIChyZXNwb25zZS5yZXN1bHQucGFnZSAtIDEpIH1cclxuICAgICAgICAgICAgICAgIF0pO1xyXG5cclxuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnJlc3VsdC5kYXRhLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgcmVzcG9uc2UubWVzc2FnZSA9IFwiRGF0YSBmZXRjaGVkXCI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzQ29kZSA9IDIwMDtcclxuICAgICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZTtcclxuXHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZSlcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBzdGF0aWMgYXN5bmMgc2F2ZVVzZXIoZGF0YSkge1xyXG4gICAgICAgIGNvbnN0IF9pZCA9IGRhdGEuX2lkO1xyXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0geyBzdGF0dXNDb2RlOiA0MDAsIG1lc3NhZ2U6ICdFcnJvciEnLCBzdGF0dXM6IGZhbHNlIH07XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRwbERhdGEgPSBfaWQgPyBhd2FpdCBVc2VyTW9kZWwuZmluZEJ5SWQoX2lkKSA6IG5ldyBVc2VyTW9kZWwoKTtcclxuXHJcbiAgICAgICAgICAgIHRwbERhdGEudHlwZSA9IGRhdGEudHlwZTtcclxuICAgICAgICAgICAgdHBsRGF0YS5maXJzdE5hbWUgPSBkYXRhLmZpcnN0TmFtZTtcclxuICAgICAgICAgICAgdHBsRGF0YS5sYXN0TmFtZSA9IGRhdGEubGFzdE5hbWU7XHJcbiAgICAgICAgICAgIHRwbERhdGEucGhvbmVObyA9IGRhdGEucGhvbmVObztcclxuICAgICAgICAgICAgdHBsRGF0YS5lbWFpbCA9IGRhdGEuZW1haWw7XHJcbiAgICAgICAgICAgIHRwbERhdGEuZW1haWxWZXJpZmllZCA9IHRydWU7XHJcbiAgICAgICAgICAgICghZGF0YS5wYXNzd29yZCB8fCAodHBsRGF0YS5wYXNzd29yZCA9IGRhdGEucGFzc3dvcmQpKTtcclxuICAgICAgICAgICAgdHBsRGF0YS5kb2IgPSBkYXRhLmRvYjtcclxuICAgICAgICAgICAgdHBsRGF0YS5waG90byA9IGF3YWl0IHVwbG9hZEZpbGUoZGF0YS5waG90bywgY29uZmlnLnVwbG9hZFBhdGhzLnVzZXIucGhvdG8sIFVzZXJNb2RlbCwgJ3Bob3RvJywgX2lkKTtcclxuXHJcbiAgICAgICAgICAgIHRwbERhdGEuYWRoYXJObyA9IGRhdGEuYWRoYXJObztcclxuICAgICAgICAgICAgdHBsRGF0YS5hZGhhckNhcmRQaG90byA9IGF3YWl0IHVwbG9hZEZpbGUoZGF0YS5hZGhhckNhcmRQaG90bywgY29uZmlnLnVwbG9hZFBhdGhzLnVzZXIuZG9jdW1lbnQsIFVzZXJNb2RlbCwgJ2FkaGFyQ2FyZFBob3RvJywgX2lkKTtcclxuXHJcbiAgICAgICAgICAgIHRwbERhdGEucGFuTm8gPSBkYXRhLnBhbk5vO1xyXG4gICAgICAgICAgICB0cGxEYXRhLnBhbkNhcmRQaG90byA9IGF3YWl0IHVwbG9hZEZpbGUoZGF0YS5wYW5DYXJkUGhvdG8sIGNvbmZpZy51cGxvYWRQYXRocy51c2VyLmRvY3VtZW50LCBVc2VyTW9kZWwsICdwYW5DYXJkUGhvdG8nLCBfaWQpO1xyXG5cclxuICAgICAgICAgICAgdHBsRGF0YS5hZGRyZXNzID0gZGF0YS5hZGRyZXNzO1xyXG4gICAgICAgICAgICB0cGxEYXRhLnN0YXRlID0gZGF0YS5zdGF0ZTtcclxuICAgICAgICAgICAgdHBsRGF0YS5kaXN0cmljdCA9IGRhdGEuZGlzdHJpY3Q7XHJcbiAgICAgICAgICAgIHRwbERhdGEudGFsdWsgPSBkYXRhLnRhbHVrO1xyXG4gICAgICAgICAgICB0cGxEYXRhLnppcGNvZGUgPSBkYXRhLnppcGNvZGU7XHJcbiAgICAgICAgICAgIHRwbERhdGEuaXNBY3RpdmUgPSBkYXRhLmlzQWN0aXZlO1xyXG5cclxuICAgICAgICAgICAgYXdhaXQgdHBsRGF0YS5zYXZlKCk7XHJcblxyXG4gICAgICAgICAgICByZXNwb25zZS5tZXNzYWdlID0gX2lkID8gXCJBZG1pbiBpcyBVcGRhdGVkXCIgOiBcIkEgbmV3IGFkbWluIGlzIGNyZWF0ZWRcIjtcclxuICAgICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzQ29kZSA9IDIwMDtcclxuICAgICAgICAgICAgcmVzcG9uc2Uuc3RhdHVzID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZTtcclxuXHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZSlcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBzdGF0aWMgYXN5bmMgZGVsZXRlVXNlcihfaWQsIGNvbmQpIHtcclxuICAgICAgICBjbGVhclNlYXJjaCh7IGNvbmQgfSk7XHJcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSB7IHN0YXR1c0NvZGU6IDQwMCwgbWVzc2FnZTogJ0Vycm9yIScsIHN0YXR1czogZmFsc2UgfTtcclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgYXdhaXQgVXNlck1vZGVsLnVwZGF0ZU9uZSh7IF9pZCwgLi4uY29uZCB9LCB7IGlzRGVsZXRlZDogdHJ1ZSB9KTtcclxuXHJcbiAgICAgICAgICAgIHJlc3BvbnNlLm1lc3NhZ2UgPSBcIkRlbGV0ZWQgc3VjY2Vzc2Z1bGx5XCI7XHJcbiAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1c0NvZGUgPSAyMDA7XHJcbiAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1cyA9IHRydWU7XHJcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZTtcclxuXHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW4gbm90IGRlbGV0ZS4gU29tZXRoaW5nIHdlbnQgd3JvbmcuXCIpXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxufSJdfQ==