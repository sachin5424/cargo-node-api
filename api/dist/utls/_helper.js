"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.clearSearch = clearSearch;
exports.decodeBase64Image = decodeBase64Image;
exports.decryptData = decryptData;
exports.deleteMultipleFiles = deleteMultipleFiles;
exports.encryptData = encryptData;
exports.getAdminFilter = getAdminFilter;
exports.mailer = mailer;
exports.slug = exports.matchPassword = void 0;
exports.uploadFile = uploadFile;
exports.uploadMultipleFile = uploadMultipleFile;

var _crypto = _interopRequireDefault(require("crypto"));

var _mail = _interopRequireDefault(require("@sendgrid/mail"));

var _Logger = _interopRequireDefault(require("./Logger"));

var _index = require("../data-base/index");

var _mime = _interopRequireDefault(require("mime"));

var _fs = _interopRequireDefault(require("fs"));

var _config = _interopRequireDefault(require("./config"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

_mail.default.setApiKey(_config.default.sendGrid.apiKey);

let matchPassword = (email, password) => {
  return new Promise((resolve, reject) => {
    _index.UserModel.findOne({
      email: email
    }, function (err, user) {
      if (err) {
        reject(err);
      } else {
        if (!user) {
          reject(err);
        } else {
          user.comparePassword(password, function (err, isMatch) {
            if (err) {
              reject(err);
            }

            resolve(isMatch);
          });
        }
      }
    });
  });
};

exports.matchPassword = matchPassword;

var slug = function (str) {
  str = str.replace(/^\s+|\s+$/g, ''); // trim

  str = str.toLowerCase(); // remove accents, swap ñ for n, etc

  var from = "ãàáäâẽèéëêìíïîõòóöôùúüûñç·/_,:;";
  var to = "aaaaaeeeeeiiiiooooouuuunc------";

  for (var i = 0, l = from.length; i < l; i++) {
    str = str.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));
  }

  str = str.replace(/[^a-z0-9 -]/g, '') // remove invalid chars
  .replace(/\s+/g, '-') // collapse whitespace and replace by -
  .replace(/-+/g, '-'); // collapse dashes

  return str;
};

exports.slug = slug;

function clearSearch(obj) {
  for (const [key, value] of Object.entries(obj)) {
    if (typeof value === "object") {
      clearSearch(value);
    } else {
      if (typeof value === 'undefined' || typeof value === 'string' && value.length < 1) {
        delete obj[key];
      }
    }
  }
}

function getAdminFilter(...keys) {
  let search = {};
  search[keys[0] ? keys[0] : 'state'] = global.state;
  search[keys[1] ? keys[1] : 'district'] = global.district;
  search[keys[2] ? keys[2] : 'taluk'] = global.taluk;
  clearSearch(search);
  return search;
}

function decodeBase64Image(dataString) {
  var matches = dataString.match(/^data:([A-Za-z-+\/]+);base64,(.+)$/),
      response = {};

  if (matches.length !== 3) {
    return new Error('Invalid input string');
  }

  response.type = matches[1];
  response.data = new Buffer.from(matches[2], 'base64');
  return response;
}

async function uploadFile(dataBase64, path, model, key, _id) {
  if (!dataBase64) {
    try {
      const f = await model.findById(_id);
      return f[key] || '';
    } catch (e) {
      return '';
    }
  }

  var decodedImg = decodeBase64Image(dataBase64);
  var imageBuffer = decodedImg.data;
  var type = decodedImg.type;

  var extension = _mime.default.getExtension(type);

  var fileName = Date.now() + '-' + Math.round(Math.random() * 1E9) + '.' + extension;

  try {
    await _fs.default.writeFileSync(path + fileName, imageBuffer, 'utf8');

    try {
      if (_id) {
        const f = await model.findById(_id);

        _fs.default.unlink(path + f[key], () => {});
      }
    } catch (e) {// new Error
    }

    return fileName;
  } catch (err) {
    throw new Error(err);
  }
}

async function uploadMultipleFile(dataBase64Array, path, model, key, _id, deletingFiles) {
  const fileNames = await deleteMultipleFiles(path, model, key, _id, deletingFiles);

  if (Array.isArray(dataBase64Array) && dataBase64Array.length > 0) {
    const prms = dataBase64Array.map(async v => {
      return uploadFile(v, path, model);
    });

    if (prms.length > 0) {
      return Promise.all(prms).then(res => {
        res.forEach(v => {
          fileNames.push(v);
        });
        return fileNames;
      });
    }
  } else {
    return fileNames;
  }
}

async function deleteMultipleFiles(path, model, key, _id, deletingFiles) {
  let tpl,
      fileNames = [];

  if (_id) {
    tpl = await model.findById(_id);
    fileNames = tpl[key]?.filter(v => !deletingFiles?.includes(v));
  }

  if (_id && Array.isArray(deletingFiles) && deletingFiles.length > 0) {
    try {
      deletingFiles.map(v => {
        _fs.default.unlink(path + v, () => {});
      });
    } catch (err) {}
  }

  return fileNames;
}

function encryptData(text) {
  let iv = _crypto.default.randomBytes(_config.default.crypto.ivLength);

  let cipher = _crypto.default.createCipheriv(_config.default.crypto.algorithm, Buffer.from(_config.default.crypto.encryptionKey, 'hex'), iv);

  let encrypted = cipher.update(text);
  encrypted = Buffer.concat([encrypted, cipher.final()]);
  return iv.toString('hex') + ':' + encrypted.toString('hex');
}

function decryptData(text) {
  let textParts = text.split(':');
  let iv = Buffer.from(textParts.shift(), 'hex');
  let encryptedText = Buffer.from(textParts.join(':'), 'hex');

  let decipher = _crypto.default.createDecipheriv(_config.default.crypto.algorithm, Buffer.from(_config.default.crypto.encryptionKey, 'hex'), iv);

  let decrypted = decipher.update(encryptedText);
  decrypted = Buffer.concat([decrypted, decipher.final()]);
  return decrypted.toString();
}

async function mailer(to, subject, html) {
  const mailOptions = {
    to,
    from: _config.default.sendGrid.senderEmail,
    subject,
    html
  };
  return new Promise(async (resolve, reject) => {
    try {
      const info = await _mail.default.send(mailOptions);
      resolve(info);
    } catch (error) {
      _Logger.default.error(`
                    Error while sending mail
                    To   			- ${to}
                    Subject   		- ${subject}
                    Reason   	    - ${error.message}
                `);

      reject(error);
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGxzL19oZWxwZXIuanMiXSwibmFtZXMiOlsic2VuZEdyaWRNYWlsIiwic2V0QXBpS2V5IiwiQ29uZmlnIiwic2VuZEdyaWQiLCJhcGlLZXkiLCJtYXRjaFBhc3N3b3JkIiwiZW1haWwiLCJwYXNzd29yZCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiVXNlck1vZGVsIiwiZmluZE9uZSIsImVyciIsInVzZXIiLCJjb21wYXJlUGFzc3dvcmQiLCJpc01hdGNoIiwic2x1ZyIsInN0ciIsInJlcGxhY2UiLCJ0b0xvd2VyQ2FzZSIsImZyb20iLCJ0byIsImkiLCJsIiwibGVuZ3RoIiwiUmVnRXhwIiwiY2hhckF0IiwiY2xlYXJTZWFyY2giLCJvYmoiLCJrZXkiLCJ2YWx1ZSIsIk9iamVjdCIsImVudHJpZXMiLCJnZXRBZG1pbkZpbHRlciIsImtleXMiLCJzZWFyY2giLCJnbG9iYWwiLCJzdGF0ZSIsImRpc3RyaWN0IiwidGFsdWsiLCJkZWNvZGVCYXNlNjRJbWFnZSIsImRhdGFTdHJpbmciLCJtYXRjaGVzIiwibWF0Y2giLCJyZXNwb25zZSIsIkVycm9yIiwidHlwZSIsImRhdGEiLCJCdWZmZXIiLCJ1cGxvYWRGaWxlIiwiZGF0YUJhc2U2NCIsInBhdGgiLCJtb2RlbCIsIl9pZCIsImYiLCJmaW5kQnlJZCIsImUiLCJkZWNvZGVkSW1nIiwiaW1hZ2VCdWZmZXIiLCJleHRlbnNpb24iLCJtaW1lIiwiZ2V0RXh0ZW5zaW9uIiwiZmlsZU5hbWUiLCJEYXRlIiwibm93IiwiTWF0aCIsInJvdW5kIiwicmFuZG9tIiwiZnMiLCJ3cml0ZUZpbGVTeW5jIiwidW5saW5rIiwidXBsb2FkTXVsdGlwbGVGaWxlIiwiZGF0YUJhc2U2NEFycmF5IiwiZGVsZXRpbmdGaWxlcyIsImZpbGVOYW1lcyIsImRlbGV0ZU11bHRpcGxlRmlsZXMiLCJBcnJheSIsImlzQXJyYXkiLCJwcm1zIiwibWFwIiwidiIsImFsbCIsInRoZW4iLCJyZXMiLCJmb3JFYWNoIiwicHVzaCIsInRwbCIsImZpbHRlciIsImluY2x1ZGVzIiwiZW5jcnlwdERhdGEiLCJ0ZXh0IiwiaXYiLCJjcnlwdG8iLCJyYW5kb21CeXRlcyIsIml2TGVuZ3RoIiwiY2lwaGVyIiwiY3JlYXRlQ2lwaGVyaXYiLCJhbGdvcml0aG0iLCJlbmNyeXB0aW9uS2V5IiwiZW5jcnlwdGVkIiwidXBkYXRlIiwiY29uY2F0IiwiZmluYWwiLCJ0b1N0cmluZyIsImRlY3J5cHREYXRhIiwidGV4dFBhcnRzIiwic3BsaXQiLCJzaGlmdCIsImVuY3J5cHRlZFRleHQiLCJqb2luIiwiZGVjaXBoZXIiLCJjcmVhdGVEZWNpcGhlcml2IiwiZGVjcnlwdGVkIiwibWFpbGVyIiwic3ViamVjdCIsImh0bWwiLCJtYWlsT3B0aW9ucyIsInNlbmRlckVtYWlsIiwiaW5mbyIsInNlbmQiLCJlcnJvciIsIkxvZ2dlciIsIm1lc3NhZ2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBQSxjQUFhQyxTQUFiLENBQXVCQyxnQkFBT0MsUUFBUCxDQUFnQkMsTUFBdkM7O0FBRUEsSUFBSUMsYUFBYSxHQUFHLENBQUNDLEtBQUQsRUFBUUMsUUFBUixLQUFxQjtBQUNyQyxTQUFPLElBQUlDLE9BQUosQ0FBWSxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FBcUI7QUFDcENDLHFCQUFVQyxPQUFWLENBQWtCO0FBQUVOLE1BQUFBLEtBQUssRUFBRUE7QUFBVCxLQUFsQixFQUFxQyxVQUFVTyxHQUFWLEVBQWVDLElBQWYsRUFBcUI7QUFDdEQsVUFBSUQsR0FBSixFQUFTO0FBQ0xILFFBQUFBLE1BQU0sQ0FBQ0csR0FBRCxDQUFOO0FBQ0gsT0FGRCxNQUdLO0FBQ0QsWUFBSSxDQUFDQyxJQUFMLEVBQVc7QUFDUEosVUFBQUEsTUFBTSxDQUFDRyxHQUFELENBQU47QUFDSCxTQUZELE1BR0s7QUFDREMsVUFBQUEsSUFBSSxDQUFDQyxlQUFMLENBQXFCUixR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QTFCLEVBQXlDLEtBQXpDLENBQWpELEVBQWtHUCxFQUFsRyxDQUFmOztBQUNBLE1BQUlxQixTQUFTLEdBQUdGLFFBQVEsQ0FBQ1YsTUFBVCxDQUFnQlEsYUFBaEIsQ0FBaEI7QUFDQUksRUFBQUEsU0FBUyxHQUFHaEUsTUFBTSxDQUFDcUQsTUFBUCxDQUFjLENBQUNXLFNBQUQsRUFBWUYsUUFBUSxDQUFDUixLQUFULEVBQVosQ0FBZCxDQUFaO0FBQ0EsU0FBT1UsU0FBUyxDQUFDVCxRQUFWLEVBQVA7QUFDSDs7QUFFTSxlQUFlVSxNQUFmLENBQXNCNUYsRUFBdEIsRUFBMEI2RixPQUExQixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFFNUMsUUFBTUMsV0FBVyxHQUFHO0FBQ2hCL0YsSUFBQUEsRUFEZ0I7QUFFaEJELElBQUFBLElBQUksRUFBRW5CLGdCQUFPQyxRQUFQLENBQWdCbUgsV0FGTjtBQUdoQkgsSUFBQUEsT0FIZ0I7QUFJaEJDLElBQUFBO0FBSmdCLEdBQXBCO0FBUUEsU0FBTyxJQUFJNUcsT0FBSixDQUFZLE9BQU9DLE9BQVAsRUFBZ0JDLE1BQWhCLEtBQTJCO0FBQzFDLFFBQUk7QUFDQSxZQUFNNkcsSUFBSSxHQUFHLE1BQU12SCxjQUFhd0gsSUFBYixDQUFrQkgsV0FBbEIsQ0FBbkI7QUFDQTVHLE1BQUFBLE9BQU8sQ0FBQzhHLElBQUQsQ0FBUDtBQUNILEtBSEQsQ0FHRSxPQUFPRSxLQUFQLEVBQWM7QUFDWkMsc0JBQU9ELEtBQVAsQ0FDSztBQUNqQjtBQUNBLGdDQUFnQ25HLEVBQUc7QUFDbkMsb0NBQW9DNkYsT0FBUTtBQUM1QyxzQ0FBc0NNLEtBQUssQ0FBQ0UsT0FBUTtBQUNwRCxpQkFOWTs7QUFRQWpILE1BQUFBLE1BQU0sQ0FBQytHLEtBQUQsQ0FBTjtBQUNIO0FBQ0osR0FmTSxDQUFQO0FBZ0JIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNyeXB0byBmcm9tIFwiY3J5cHRvXCI7XHJcbmltcG9ydCBzZW5kR3JpZE1haWwgZnJvbSAnQHNlbmRncmlkL21haWwnO1xyXG5pbXBvcnQgTG9nZ2VyIGZyb20gXCIuL0xvZ2dlclwiO1xyXG5pbXBvcnQgeyBVc2VyTW9kZWwgfSBmcm9tIFwiLi4vZGF0YS1iYXNlL2luZGV4XCI7XHJcbmltcG9ydCBtaW1lIGZyb20gXCJtaW1lXCI7XHJcbmltcG9ydCBmcyBmcm9tIFwiZnNcIjtcclxuaW1wb3J0IENvbmZpZyBmcm9tIFwiLi9jb25maWdcIjtcclxuXHJcbnNlbmRHcmlkTWFpbC5zZXRBcGlLZXkoQ29uZmlnLnNlbmRHcmlkLmFwaUtleSk7XHJcblxyXG5sZXQgbWF0Y2hQYXNzd29yZCA9IChlbWFpbCwgcGFzc3dvcmQpID0+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgVXNlck1vZGVsLmZpbmRPbmUoeyBlbWFpbDogZW1haWwsIH0sIGZ1bmN0aW9uIChlcnIsIHVzZXIpIHtcclxuICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXVzZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHVzZXIuY29tcGFyZVBhc3N3b3JkKHBhc3N3b3JkLCBmdW5jdGlvbiAoZXJyLCBpc01hdGNoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoaXNNYXRjaCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59O1xyXG52YXIgc2x1ZyA9IGZ1bmN0aW9uIChzdHIpIHtcclxuICAgIHN0ciA9IHN0ci5yZXBsYWNlKC9eXFxzK3xcXHMrJC9nLCAnJyk7IC8vIHRyaW1cclxuICAgIHN0ciA9IHN0ci50b0xvd2VyQ2FzZSgpO1xyXG4gICAgLy8gcmVtb3ZlIGFjY2VudHMsIHN3YXAgw7EgZm9yIG4sIGV0Y1xyXG4gICAgdmFyIGZyb20gPSBcIsOjw6DDocOkw6Lhur3DqMOpw6vDqsOsw63Dr8Ouw7XDssOzw7bDtMO5w7rDvMO7w7HDp8K3L18sOjtcIjtcclxuICAgIHZhciB0byA9IFwiYWFhYWFlZWVlZWlpaWlvb29vb3V1dXVuYy0tLS0tLVwiO1xyXG4gICAgZm9yICh2YXIgaSA9IDAsIGwgPSBmcm9tLmxlbmd0aDsgaSA8IGw7IGkrKykge1xyXG4gICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKG5ldyBSZWdFeHAoZnJvbS5jaGFyQXQoaSksICdnJyksIHRvLmNoYXJBdChpKSk7XHJcbiAgICB9XHJcbiAgICBzdHIgPSBzdHIucmVwbGFjZSgvW15hLXowLTkgLV0vZywgJycpIC8vIHJlbW92ZSBpbnZhbGlkIGNoYXJzXHJcbiAgICAgICAgLnJlcGxhY2UoL1xccysvZywgJy0nKSAvLyBjb2xsYXBzZSB3aGl0ZXNwYWNlIGFuZCByZXBsYWNlIGJ5IC1cclxuICAgICAgICAucmVwbGFjZSgvLSsvZywgJy0nKTsgLy8gY29sbGFwc2UgZGFzaGVzXHJcbiAgICByZXR1cm4gc3RyO1xyXG59O1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNsZWFyU2VhcmNoKG9iaikge1xyXG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMob2JqKSkge1xyXG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09IFwib2JqZWN0XCIpIHtcclxuICAgICAgICAgICAgY2xlYXJTZWFyY2godmFsdWUpXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgJiYgdmFsdWUubGVuZ3RoIDwgMSkpIHtcclxuICAgICAgICAgICAgICAgIGRlbGV0ZSAob2JqW2tleV0pXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRBZG1pbkZpbHRlciguLi5rZXlzKSB7XHJcbiAgICBsZXQgc2VhcmNoID0ge307XHJcbiAgICBzZWFyY2hba2V5c1swXSA/IGtleXNbMF0gOiAnc3RhdGUnXSA9IGdsb2JhbC5zdGF0ZTtcclxuICAgIHNlYXJjaFtrZXlzWzFdID8ga2V5c1sxXSA6ICdkaXN0cmljdCddID0gZ2xvYmFsLmRpc3RyaWN0O1xyXG4gICAgc2VhcmNoW2tleXNbMl0gPyBrZXlzWzJdIDogJ3RhbHVrJ10gPSBnbG9iYWwudGFsdWs7XHJcbiAgICBjbGVhclNlYXJjaChzZWFyY2gpO1xyXG4gICAgcmV0dXJuIHNlYXJjaDtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGRlY29kZUJhc2U2NEltYWdlKGRhdGFTdHJpbmcpIHtcclxuICAgIHZhciBtYXRjaGVzID0gZGF0YVN0cmluZy5tYXRjaCgvXmRhdGE6KFtBLVphLXotK1xcL10rKTtiYXNlNjQsKC4rKSQvKSwgcmVzcG9uc2UgPSB7fTtcclxuXHJcbiAgICBpZiAobWF0Y2hlcy5sZW5ndGggIT09IDMpIHtcclxuICAgICAgICByZXR1cm4gbmV3IEVycm9yKCdJbnZhbGlkIGlucHV0IHN0cmluZycpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlc3BvbnNlLnR5cGUgPSBtYXRjaGVzWzFdO1xyXG4gICAgcmVzcG9uc2UuZGF0YSA9IG5ldyBCdWZmZXIuZnJvbShtYXRjaGVzWzJdLCAnYmFzZTY0Jyk7XHJcblxyXG4gICAgcmV0dXJuIHJlc3BvbnNlO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBsb2FkRmlsZShkYXRhQmFzZTY0LCBwYXRoLCBtb2RlbCwga2V5LCBfaWQpIHtcclxuICAgIGlmICghZGF0YUJhc2U2NCkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGYgPSBhd2FpdCBtb2RlbC5maW5kQnlJZChfaWQpO1xyXG4gICAgICAgICAgICByZXR1cm4gZltrZXldIHx8ICcnO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcbiAgICB2YXIgZGVjb2RlZEltZyA9IGRlY29kZUJhc2U2NEltYWdlKGRhdGFCYXNlNjQpO1xyXG4gICAgdmFyIGltYWdlQnVmZmVyID0gZGVjb2RlZEltZy5kYXRhO1xyXG4gICAgdmFyIHR5cGUgPSBkZWNvZGVkSW1nLnR5cGU7XHJcbiAgICB2YXIgZXh0ZW5zaW9uID0gbWltZS5nZXRFeHRlbnNpb24odHlwZSk7XHJcbiAgICB2YXIgZmlsZU5hbWUgPSBEYXRlLm5vdygpICsgJy0nICsgTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogMUU5KSArICcuJyArIGV4dGVuc2lvbjtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgYXdhaXQgZnMud3JpdGVGaWxlU3luYyhwYXRoICsgZmlsZU5hbWUsIGltYWdlQnVmZmVyLCAndXRmOCcpO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGlmIChfaWQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGYgPSBhd2FpdCBtb2RlbC5maW5kQnlJZChfaWQpO1xyXG4gICAgICAgICAgICAgICAgZnMudW5saW5rKHBhdGggKyBmW2tleV0sICgpID0+IHsgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIC8vIG5ldyBFcnJvclxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmlsZU5hbWVcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihlcnIpXHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cGxvYWRNdWx0aXBsZUZpbGUoZGF0YUJhc2U2NEFycmF5LCBwYXRoLCBtb2RlbCwga2V5LCBfaWQsIGRlbGV0aW5nRmlsZXMpIHtcclxuICAgIGNvbnN0IGZpbGVOYW1lcyA9IGF3YWl0IGRlbGV0ZU11bHRpcGxlRmlsZXMocGF0aCwgbW9kZWwsIGtleSwgX2lkLCBkZWxldGluZ0ZpbGVzKTtcclxuICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGFCYXNlNjRBcnJheSkgJiYgZGF0YUJhc2U2NEFycmF5Lmxlbmd0aCA+IDApIHtcclxuICAgICAgICBjb25zdCBwcm1zID0gZGF0YUJhc2U2NEFycmF5Lm1hcChhc3luYyAodikgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gdXBsb2FkRmlsZSh2LCBwYXRoLCBtb2RlbCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGlmIChwcm1zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHBybXMpLnRoZW4ocmVzID0+IHtcclxuICAgICAgICAgICAgICAgIHJlcy5mb3JFYWNoKHYgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGZpbGVOYW1lcy5wdXNoKHYpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIHJldHVybiBmaWxlTmFtZXM7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIGZpbGVOYW1lcztcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRlbGV0ZU11bHRpcGxlRmlsZXMocGF0aCwgbW9kZWwsIGtleSwgX2lkLCBkZWxldGluZ0ZpbGVzKSB7XHJcbiAgICBsZXQgdHBsLCBmaWxlTmFtZXMgPSBbXTtcclxuXHJcbiAgICBpZihfaWQpe1xyXG4gICAgICAgIHRwbCA9IGF3YWl0IG1vZGVsLmZpbmRCeUlkKF9pZCk7XHJcbiAgICAgICAgZmlsZU5hbWVzID0gdHBsW2tleV0/LmZpbHRlcih2ID0+ICFkZWxldGluZ0ZpbGVzPy5pbmNsdWRlcyh2KSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKF9pZCAmJiBBcnJheS5pc0FycmF5KGRlbGV0aW5nRmlsZXMpICYmIGRlbGV0aW5nRmlsZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGRlbGV0aW5nRmlsZXMubWFwKHYgPT4ge1xyXG4gICAgICAgICAgICAgICAgZnMudW5saW5rKHBhdGggKyB2LCAoKSA9PiB7IH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcblxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBmaWxlTmFtZXM7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBlbmNyeXB0RGF0YSh0ZXh0KSB7XHJcbiAgICBsZXQgaXYgPSBjcnlwdG8ucmFuZG9tQnl0ZXMoQ29uZmlnLmNyeXB0by5pdkxlbmd0aCk7XHJcbiAgICBsZXQgY2lwaGVyID0gY3J5cHRvLmNyZWF0ZUNpcGhlcml2KENvbmZpZy5jcnlwdG8uYWxnb3JpdGhtLCBCdWZmZXIuZnJvbShDb25maWcuY3J5cHRvLmVuY3J5cHRpb25LZXksICdoZXgnKSwgaXYpO1xyXG4gICAgbGV0IGVuY3J5cHRlZCA9IGNpcGhlci51cGRhdGUodGV4dCk7XHJcbiAgICBlbmNyeXB0ZWQgPSBCdWZmZXIuY29uY2F0KFtlbmNyeXB0ZWQsIGNpcGhlci5maW5hbCgpXSk7XHJcbiAgICByZXR1cm4gaXYudG9TdHJpbmcoJ2hleCcpICsgJzonICsgZW5jcnlwdGVkLnRvU3RyaW5nKCdoZXgnKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGRlY3J5cHREYXRhKHRleHQpIHtcclxuICAgIGxldCB0ZXh0UGFydHMgPSB0ZXh0LnNwbGl0KCc6Jyk7XHJcbiAgICBsZXQgaXYgPSBCdWZmZXIuZnJvbSh0ZXh0UGFydHMuc2hpZnQoKSwgJ2hleCcpO1xyXG4gICAgbGV0IGVuY3J5cHRlZFRleHQgPSBCdWZmZXIuZnJvbSh0ZXh0UGFydHMuam9pbignOicpLCAnaGV4Jyk7XHJcbiAgICBsZXQgZGVjaXBoZXIgPSBjcnlwdG8uY3JlYXRlRGVjaXBoZXJpdihDb25maWcuY3J5cHRvLmFsZ29yaXRobSwgQnVmZmVyLmZyb20oQ29uZmlnLmNyeXB0by5lbmNyeXB0aW9uS2V5LCAnaGV4JyksIGl2KTtcclxuICAgIGxldCBkZWNyeXB0ZWQgPSBkZWNpcGhlci51cGRhdGUoZW5jcnlwdGVkVGV4dCk7XHJcbiAgICBkZWNyeXB0ZWQgPSBCdWZmZXIuY29uY2F0KFtkZWNyeXB0ZWQsIGRlY2lwaGVyLmZpbmFsKCldKTtcclxuICAgIHJldHVybiBkZWNyeXB0ZWQudG9TdHJpbmcoKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG1haWxlcih0bywgc3ViamVjdCwgaHRtbCkge1xyXG5cclxuICAgIGNvbnN0IG1haWxPcHRpb25zID0ge1xyXG4gICAgICAgIHRvLFxyXG4gICAgICAgIGZyb206IENvbmZpZy5zZW5kR3JpZC5zZW5kZXJFbWFpbCxcclxuICAgICAgICBzdWJqZWN0LFxyXG4gICAgICAgIGh0bWwsXHJcbiAgICB9O1xyXG5cclxuXHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGluZm8gPSBhd2FpdCBzZW5kR3JpZE1haWwuc2VuZChtYWlsT3B0aW9ucyk7XHJcbiAgICAgICAgICAgIHJlc29sdmUoaW5mbyk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgTG9nZ2VyLmVycm9yKFxyXG4gICAgICAgICAgICAgICAgYFxyXG4gICAgICAgICAgICAgICAgICAgIEVycm9yIHdoaWxlIHNlbmRpbmcgbWFpbFxyXG4gICAgICAgICAgICAgICAgICAgIFRvICAgXHRcdFx0LSAke3RvfVxyXG4gICAgICAgICAgICAgICAgICAgIFN1YmplY3QgICBcdFx0LSAke3N1YmplY3R9XHJcbiAgICAgICAgICAgICAgICAgICAgUmVhc29uICAgXHQgICAgLSAke2Vycm9yLm1lc3NhZ2V9XHJcbiAgICAgICAgICAgICAgICBgXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgfSlcclxufSBcclxuXHJcblxyXG5cclxuXHJcbmV4cG9ydCB7IG1hdGNoUGFzc3dvcmQsIHNsdWcgfTtcclxuIl19